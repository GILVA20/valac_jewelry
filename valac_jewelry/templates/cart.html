{% extends "base.html" %}

{% block title %}Carrito - VALAC Joyas{% endblock %}

{% block content %}
<style>
  .discount-badge{
    position:absolute;top:1rem;right:1rem;background:#000;color:#fff;font-size:.75rem;
    font-weight:600;text-transform:uppercase;padding:.25rem .75rem;border-radius:9999px;z-index:10
  }
  .product-detail-container{position:relative}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>

<main class="pt-32 md:pt-36 container mx-auto px-4 md:px-6 pb-16">
  {% if not products %}
    <script>
      console.log("DEBUG: No hay productos en el carrito. Limpiando localStorage.");
      localStorage.removeItem('cartItems');
    </script>
  {% endif %}

  <div class="flex flex-col md:flex-row gap-8">
    <!-- Lista de productos -->
    <section class="w-full md:w-2/3">
      <h1 class="text-3xl md:text-4xl font-bold text-[#333333] mb-8 font-playfair">Tus Art√≠culos</h1>

      {% if products %}
        <div class="space-y-6" id="cart-items">
          {% for p in products %}
          <div class="bg-white p-5 rounded-lg shadow-md flex flex-col product-card" data-product-id="{{ p.id }}">
            <img src="{{ p.imagen or url_for('static', filename='images/placeholder.jpg') }}" alt="{{ p.nombre }}" class="w-full h-64 object-cover mb-4 rounded">
            <h3 class="text-xl md:text-2xl font-semibold text-[#333333] font-playfair">{{ p.nombre }}</h3>

            {% if p.descuento_pct and p.descuento_pct > 0 %}
              <p class="text-gray-500 line-through mt-2">${{ "%.2f"|format(p.precio) }}</p>
              <p class="text-lg font-bold text-red-600 mt-1">${{ "%.2f"|format(p.unit_price) }}</p>
            {% else %}
              <p class="text-gray-800 mt-2 font-bold">${{ "%.2f"|format(p.unit_price) }}</p>
            {% endif %}

            <!-- Cantidad (form para actualizar) -->
            <form method="POST" action="{{ url_for('cart.update_quantity', product_id=p.id) }}" class="mt-4 flex items-center gap-3">
              <label for="qty-{{ p.id }}" class="text-gray-700 font-medium">Cantidad:</label>
              <input id="qty-{{ p.id }}" name="quantity" type="number" min="0" value="{{ p.cantidad or 1 }}"
                     class="w-24 border border-gray-300 p-2 rounded" inputmode="numeric">
              <button type="submit" class="bg-gray-800 text-white px-3 py-2 rounded hover:bg-black transition-colors">
                Actualizar
              </button>
            </form>

            <!-- Eliminar -->
            <form method="POST" action="{{ url_for('cart.remove_from_cart', product_id=p.id) }}" class="mt-3">
              <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-full hover:bg-red-700 transition-colors"
                      aria-label="Eliminar producto {{ p.nombre }}">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-600 text-center">No hay productos en el carrito.</p>
      {% endif %}
    </section>

    <!-- Resumen / Cup√≥n -->
    <aside class="w-full md:w-1/3 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl md:text-3xl font-bold font-playfair mb-4">Resumen de Compra</h2>

      {% set _subtotal = subtotalProducts if subtotalProducts is defined else 0.0 %}
      {% set _shipping = shipping_amount if shipping_amount is defined else (shipping if shipping is defined else 0.0) %}
      {% set _precoup  = preCoupon if preCoupon is defined else (_subtotal + _shipping) %}
      {% set _disc     = discount_total if discount_total is defined else 0.0 %}
      {% set _total    = total if total is defined else (_precoup - _disc) %}
      {% set _coupon   = coupon_code if coupon_code is defined else None %}
      {% set _base     = coupon_percent_base if coupon_percent_base is defined else 'products' %}

      <!-- 1) Productos -->
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Productos:</span>
        <span class="font-bold text-gray-900">${{ '%.2f'|format(_subtotal) }}</span>
      </div>

      <!-- 2) Env√≠o -->
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Env√≠o:</span>
        <span class="font-bold text-gray-900">${{ '%.2f'|format(_shipping) }}</span>
      </div>

      <!-- 3) Subtotal -->
      <div class="flex justify-between mb-2 border-t pt-2">
        <span class="text-gray-700">Subtotal (productos + env√≠o):</span>
        <span class="font-bold text-gray-900">${{ '%.2f'|format(_precoup) }}</span>
      </div>

      <!-- 4) Descuento -->
      <div class="flex justify-between mb-2 {% if not _disc or _disc <= 0 %}hidden{% endif %}" id="discountRow">
        <span class="text-gray-700">
          Descuento cup√≥n{% if _coupon %} ({{ _coupon }}){% endif %}
          {% if _base == 'products_plus_shipping' %}
            <small class="text-gray-500">aplicado sobre productos + env√≠o</small>
          {% else %}
            <small class="text-gray-500">aplicado s√≥lo sobre productos</small>
          {% endif %}:
        </span>
        <span id="discountAmount" class="font-bold text-gray-900">-${{ '%.2f'|format(_disc) }}</span>
      </div>

      <!-- 5) Total -->
      <div class="flex justify-between mb-4 border-t pt-2">
        <span class="text-gray-700">Total:</span>
        <span id="total" class="font-bold text-gray-900">${{ '%.2f'|format(_total) }}</span>
      </div>

      <!-- Cup√≥n -->
      <div class="coupon-section" data-aos="fade-up" data-aos-duration="1000">
        <label for="coupon" class="block text-gray-700 mb-2 text-lg">C√≥digo de Cup√≥n</label>
        <div class="flex gap-2">
          <input type="text" id="coupon" class="coupon-input border border-gray-300 p-2 rounded w-full"
                 placeholder="Ingresa tu cup√≥n" aria-label="C√≥digo de Cup√≥n" value="{{ _coupon or '' }}">
          <button id="apply-coupon-btn"
                  class="apply-coupon-btn bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors"
                  aria-label="Aplicar Cup√≥n">
            Aplicar
          </button>
          {% if _coupon %}
          <button id="remove-coupon-btn"
                  class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition-colors"
                  aria-label="Quitar cup√≥n">
            Quitar
          </button>
          {% endif %}
        </div>
        <p id="coupon-message" class="hidden text-green-600 font-semibold mt-2" role="status" aria-live="polite">
          ¬°Cup√≥n aplicado con √©xito!
        </p>
        <p id="coupon-error" class="hidden text-red-600 font-semibold mt-2" role="alert">
          No se pudo aplicar el cup√≥n.
        </p>
      </div>

      <button id="checkout-btn"
              class="mt-6 w-full bg-gradient-to-r from-[#D4AF37] to-[#C09330] hover:from-[#B38F00] hover:to-[#967700]
                     text-white px-6 py-3 rounded-full font-semibold transition-colors shadow-md"
              aria-label="Proceder al Pago">
        Proceder al Pago
      </button>

      <!-- Alternativa: Comprar por WhatsApp -->
      <div class="mt-4 text-center">
        <p class="text-gray-500 text-sm mb-3">‚Äî o si prefieres ‚Äî</p>
        <a id="whatsapp-cart-btn"
           href="#"
           target="_blank"
           rel="noopener noreferrer"
           onclick="trackWhatsAppClick('cart')"
           class="w-full inline-flex items-center justify-center gap-2 bg-[#25D366] hover:bg-[#1da851] 
                  text-white px-6 py-3 rounded-full font-semibold transition-colors shadow-md">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          Consultar por WhatsApp
        </a>
        <p class="text-gray-400 text-xs mt-2">Te atendemos al instante üí¨</p>
      </div>

      <!-- Datos ocultos -->
      <div class="sr-only"
           data-subtotal="{{ '%.2f'|format(_subtotal) }}"
           data-shipping="{{ '%.2f'|format(_shipping) }}"
           data-precoupon="{{ '%.2f'|format(_precoup) }}"
           data-discount="{{ '%.2f'|format(_disc) }}"
           data-total="{{ '%.2f'|format(_total) }}"
           data-coupon="{{ _coupon or '' }}"
           data-base="{{ _base }}"></div>
    </aside>
  </div>
</main>
{% endblock %}

{% block scripts_extra %}
<script>
  // Persistencia ligera del listado
  (function seedLocalStorage() {
    const items = [
      {% for p in products %}
      {
        id: {{ p.id }},
        nombre: {{ p.nombre|tojson }},
        precio: {{ '%.2f'|format(p.unit_price) }},
        cantidad: {{ p.cantidad or 1 }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    if (items.length) {
      localStorage.setItem('cartItems', JSON.stringify(items));
    } else {
      localStorage.removeItem('cartItems');
    }
  })();

  // Aplicar cup√≥n
  document.getElementById('apply-coupon-btn')?.addEventListener('click', async () => {
    const codeInput = document.getElementById('coupon');
    const code = (codeInput?.value || '').trim().toUpperCase();
    const okMsg = document.getElementById('coupon-message');
    const errMsg = document.getElementById('coupon-error');
    okMsg?.classList.add('hidden'); errMsg?.classList.add('hidden');

    if (!code) { alert('Ingresa un c√≥digo.'); return; }

    try {
      const r = await fetch('{{ url_for("cart.cart_apply_coupon") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ code })
      });
      const j = await r.json().catch(() => ({}));

      if (r.ok && j.ok) {
        okMsg?.classList.remove('hidden');
        window.location.reload();
        return;
      }

      if (r.status === 409 && j.reason === 'already_applied') {
        alert('Ya hay un cup√≥n aplicado a este carrito.');
      } else if (r.status === 400) {
        alert('C√≥digo inv√°lido.');
      } else {
        errMsg?.classList.remove('hidden');
      }
    } catch (e) {
      console.error(e);
      alert('Error al aplicar el cup√≥n.');
    }
  });

  // Remover cup√≥n
  document.getElementById('remove-coupon-btn')?.addEventListener('click', async () => {
    try {
      const r = await fetch('{{ url_for("cart.cart_remove_coupon") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      });
      if (r.ok) {
        window.location.reload();
      } else {
        alert('No se pudo quitar el cup√≥n.');
      }
    } catch (e) {
      console.error(e);
      alert('Error al quitar el cup√≥n.');
    }
  });

  // Ir a checkout
  document.getElementById('checkout-btn')?.addEventListener('click', () => {
    window.location.href = '{{ url_for("checkout.checkout") }}';
  });

  // Construir link de WhatsApp con productos del carrito
  (function buildWhatsAppLink() {
    const waBtn = document.getElementById('whatsapp-cart-btn');
    if (!waBtn) return;
    
    const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    const total = document.querySelector('[data-total]')?.dataset.total || '0.00';
    
    let mensaje = 'Hola! üëã Me interesan estos productos:\n\n';
    
    if (cartItems.length > 0) {
      cartItems.forEach((item, i) => {
        mensaje += `${i + 1}. ${item.nombre} - $${item.precio} x${item.cantidad}\n`;
      });
      mensaje += `\nüí∞ Total: $${total}\n\n`;
    } else {
      mensaje = 'Hola! Me interesa hacer un pedido de joyas ‚ú®\n\n';
    }
    
    mensaje += '¬øPodr√≠an darme informaci√≥n?';
    
    const encoded = encodeURIComponent(mensaje);
    waBtn.href = `https://wa.me/{{ config.WHATSAPP_NUMBER|default('5215512345678') }}?text=${encoded}`;
  })();

  document.addEventListener("DOMContentLoaded", () => {
    if (window.AOS) AOS.init();
  });
</script>
{% include 'partials/tracking.html' %}
{% endblock %}
