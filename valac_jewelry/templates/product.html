{% extends "base.html" %}

{% block title %}
  {{ product.nombre }} - VALAC Joyas
{% endblock %}

{% block content %}
  <style>
    /* Badge “En oferta” estilo pill */
    .discount-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background-color: #000;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      z-index: 10;
    }
    .product-detail-container {
      position: relative;
    }
  </style>

  <div class="product-detail-container container mx-auto p-6 pt-32 md:pt-36">
    {% if product.descuento_pct and product.descuento_pct > 0 %}
      <div class="discount-badge">
        En oferta {{ product.descuento_pct }}%
      </div>
    {% endif %}
    <div class="flex flex-col lg:flex-row gap-12 lg:gap-20 xl:gap-24">
      <!-- Slider de Imágenes del Producto -->
      <div class="md:w-1/2 flex flex-col lg:flex-row gap-4">
        <!-- GALERÍA DE IMÁGENES: miniaturas + principal -->
        <div class="hidden lg:flex flex-col gap-2">
          {% for img in product.images %}
            <button
              class="thumbnail w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent focus:outline-none focus:border-[#d5a300] transition-colors"
              data-index="{{ loop.index0 }}"
              aria-label="Ver imagen {{ loop.index }}"
            >
              <img
                src="{{ img.imagen }}"
                alt="{{ product.nombre }} (vista {{ loop.index }})"
                class="object-cover w-full h-full"
                loading="lazy"
              >
            </button>
          {% endfor %}
        </div>

        <div class="relative w-full aspect-[4/5] bg-gray-100 rounded-lg overflow-hidden group">
          <!-- Flechas -->
          <button
            class="prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow focus:outline-none"
            aria-label="Imagen anterior"
          >&larr;</button>
          <button
            class="next absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow focus:outline-none"
            aria-label="Siguiente imagen"
          >&rarr;</button>

          <!-- Imagen principal -->
          {% for img in product.images %}
            <img
              src="{{ img.imagen }}"
              alt="{{ product.nombre }} (vista {{ loop.index }})"
              class="main-img absolute inset-0 w-full h-full object-cover transition-opacity duration-300 ease-in-out
                     {% if not loop.first %} opacity-0 {% endif %}"
              data-index="{{ loop.index0 }}"
              loading="lazy"
              srcset="{{ img.imagen }} 400w, {{ img.imagen }} 800w"
              sizes="(max-width: 640px) 100vw, 50vw"
            >
          {% endfor %}
        </div>
        <!-- miniaturas mobile: fila horizontal swipeable -->
        <div class="lg:hidden flex overflow-x-auto space-x-2 mb-4 py-2">
          {% for img in product.images %}
            <button
              class="thumbnail w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden border-2 border-transparent focus:outline-none focus:border-[#d5a300]"
              data-index="{{ loop.index0 }}"
              aria-label="Ver imagen {{ loop.index }}"
            >
              <img src="{{ img.imagen }}"
                   alt="{{ product.nombre }} (miniatura {{ loop.index }})"
                   class="object-cover w-full h-full"
                   loading="lazy">
            </button>
          {% endfor %}
        </div>       
      </div>

      <!-- Información del Producto -->
      <div class="w-full lg:w-1/2">
        <h1 class="text-3xl md:text-4xl font-bold text-[#333333] mb-6 font-playfair break-words min-h-[3rem]">{{ product.nombre }}</h1>

        {% if product.descuento_pct and product.descuento_pct > 0 %}
          <p class="text-gray-500 line-through mt-4 text-lg">
            ${{ '%.2f'|format(product.precio) }}
          </p>
          <p class="text-3xl font-bold text-red-600 mt-1">
            ${{ '%.2f'|format(product.precio_descuento) }}
          </p>
        {% else %}
          <p class="text-3xl font-semibold text-gray-800 mt-4">
            ${{ '%.2f'|format(product.precio) }}
          </p>
        {% endif %}

        <p class="text-sm text-gray-600 mb-4 leading-snug font-medium">
          Tipo de Oro: {{ product.tipo_oro }}<br>
          Género: {{ product.genero }}<br>
          Categoría: {{ product.tipo_producto }}
          {% if product.peso %}<br>Peso: {{ product.peso }} g{% endif %}
        </p>
        <p class="mb-6 text-gray-800">{{ product.descripcion }}</p>
        <div class="flex flex-wrap gap-4">
          {% if product.stock_total == 0 %}
              <button disabled class="bg-gray-400 text-white px-4 py-2 rounded opacity-50 cursor-not-allowed">Agotado</button>
            {% else %}
              <form action="{{ url_for('cart.add_to_cart', product_id=product.id) }}" method="POST" class="inline-block">
  <button 
    type="submit" 
    onclick="trackBuyClick({{ product.id }})"
    class="bg-[#d5a300] text-white px-6 py-3 rounded hover:bg-[#b38f00] transition-colors">
    <i class="fas fa-shopping-cart"></i> Agregar al Carrito
  </button>
</form>
            {% endif %}

            {% if 0 < product.stock_total <= 1 %}
              <p class="text-sm text-red-500 mt-2">Última pieza disponible</p>
            {% endif %}
        </div>
        <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4">
    <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
      <button id="tab-envios" class="tab-button text-gray-600 hover:text-[#d5a300] py-2 font-semibold border-b-2 border-transparent focus:outline-none focus:border-[#d5a300] active">
        Información de Envíos
      </button>
      <button id="tab-politicas" class="tab-button text-gray-600 hover:text-[#d5a300] py-2 font-semibold border-b-2 border-transparent focus:outline-none focus:border-[#d5a300]">
        Políticas
      </button>
    </nav>
  </div>

  <!-- Contenido de Tabs -->
  <div id="tab-content-envios" class="tab-content text-gray-700 space-y-4">
    <p>Todos los envíos cuentan con <strong>seguro ante pérdida o daño</strong>. Si tu paquete no llega, se repondrá con productos del catálogo equivalentes.</p>
    <p>Procesamos tu pedido de <strong>1 a 3 días hábiles</strong>. El envío tarda de <strong>5 a 8 días hábiles</strong> según la zona.</p>
    <p><strong>No realizamos envíos los viernes</strong>.</p>
  </div>
  <div id="tab-content-politicas" class="tab-content hidden text-gray-700 space-y-4">
    <p>Los tiempos de procesamiento son de 1 a 3 días hábiles y el envío de 5 a 8 días.</p>
    <p>Consulta nuestra política completa <a href="/politicas" class="text-[#d5a300] underline hover:text-[#b38f00]">aquí</a>.</p>
  </div>
</div>
      </div>
    </div>
<!-- Sección de Información de Envíos y Políticas -->
    <div class="mt-12">
      <h2 class="text-2xl font-semibold text-[#424242] mb-6">También te puede interesar</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
        {% for rp in related_products %}
          {# Preparar imágenes #}
          {% set imgs      = rp.product_images|sort(attribute='orden') %}
          {% set main_img  = imgs[0].imagen if imgs|length > 0 else (rp.imagen or None) %}
          {% set hover_img = imgs[1].imagen if imgs|length > 1 else None %}

          <div class="bg-white p-5 rounded-lg shadow-lg transform transition-transform hover:scale-105 hover:shadow-xl group"
               data-aos="fade-up" data-aos-delay="{{ loop.index0 * 50 }}">
            <div class="relative w-full h-64 overflow-hidden rounded-lg bg-gray-100">
              {% if rp.descuento_pct and rp.descuento_pct > 0 %}
                <div class="discount-badge">-{{ rp.descuento_pct }}%</div>
              {% endif %}

              {# Imagen principal o fallback #}
              {% if main_img %}
                <img
                  src="{{ main_img }}" alt="{{ rp.nombre }}"
                  class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 {% if hover_img %}group-hover:opacity-0{% endif %}"
                  loading="lazy"
                >
              {% else %}
                <div class="absolute inset-0 flex items-center justify-center bg-gray-200 text-gray-400 text-sm">
                  Sin imagen
                </div>
              {% endif %}

              {# Imagen hover #}
              {% if hover_img %}
                <img
                  src="{{ hover_img }}" alt="{{ rp.nombre }} hover"
                  class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                  loading="lazy"
                >
              {% endif %}

              {# DEBUG en consola #}
              <script>console.log("RP {{ rp.id }} → main_img:", "{{ main_img }}", " hover_img:", "{{ hover_img }}");</script>
            </div>

            <h3 class="mt-4 text-xl font-semibold text-[#424242]">{{ rp.nombre }}</h3>
            {% if rp.descuento_pct and rp.descuento_pct > 0 %}
              <p class="text-gray-500 line-through mt-1">${{ '%.2f'|format(rp.precio) }}</p>
              <p class="text-lg font-bold text-red-600">${{ '%.2f'|format(rp.precio_descuento) }}</p>
            {% else %}
              <p class="text-lg font-semibold text-gray-800 mt-2">${{ '%.2f'|format(rp.precio) }}</p>
            {% endif %}
            <a href="{{ url_for('products.product_detail', product_id=rp.id) }}"
               class="inline-block mt-4 bg-[#d5a300] text-white px-4 py-2 rounded hover:bg-[#b38f00] transition-colors">
              Ver detalles
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
  // Inicializar Slick Slider para el slider de producto
  $(document).ready(function(){
    const thumbs = document.querySelectorAll('.thumbnail');
    const mains  = document.querySelectorAll('.main-img');
    let current = 0;

    function showImage(idx) {
      mains.forEach(img => img.classList.add('opacity-0'));
      mains[idx].classList.remove('opacity-0');
      thumbs.forEach(btn => btn.classList.remove('border-[#d5a300]'));
      thumbs[idx].classList.add('border-[#d5a300]');
      current = idx;
    }

    // Click en miniatura
    thumbs.forEach(btn => {
      btn.addEventListener('click', () => showImage(+btn.dataset.index));
    });

    // Flechas prev/next
    document.querySelector('.prev').addEventListener('click', () => {
      showImage((current - 1 + mains.length) % mains.length);
    });
    document.querySelector('.next').addEventListener('click', () => {
      showImage((current + 1) % mains.length);
    });

    // Teclado
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft')  showImage((current - 1 + mains.length) % mains.length);
      if (e.key === 'ArrowRight') showImage((current + 1) % mains.length);
    });

    // Swipe (touch) móvil
    // Swipe (touch) móvil
    let startX = 0;
    const container = document.querySelector('.relative.w-full');
    container.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    container.addEventListener('touchend',   e => {
      let diff = e.changedTouches[0].clientX - startX;
      if (diff > 50)   showImage((current - 1 + mains.length) % mains.length);
      if (diff < -50)  showImage((current + 1) % mains.length);
    });

    // Inicializar AOS (ahora dentro del mismo ready)
    AOS.init();
  });
</script>

<script>
  const sessionId = localStorage.getItem("valac_session_id") || crypto.randomUUID();
  localStorage.setItem("valac_session_id", sessionId);

  // TRACK general de navegación
  fetch("/admin/analytics/track_navigation", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path: window.location.pathname, session_id: sessionId })
  });

  // Registrar vista del producto
   fetch("/admin/analytics/track_view/{{ product.id }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ session_id: sessionId })
  });

  // Función para click en comprar
  function trackBuyClick(productId) {
    fetch(`/admin/analytics/track_buy_click/${productId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id: sessionId })
    });
  }
</script>
<script>
  document.querySelectorAll('.ver-detalles-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const productId = this.dataset.id;
      const sessionId = localStorage.getItem("valac_session_id");

      fetch(`/admin/analytics/track_view/${productId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sessionId })
      }).finally(() => {
        window.location.href = this.href;
      });
    });
  });
</script>
<script>
  const tabs = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach((tab, i) => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('text-[#d5a300]', 'border-[#d5a300]', 'active'));
      tab.classList.add('text-[#d5a300]', 'border-[#d5a300]', 'active');

      tabContents.forEach(c => c.classList.add('hidden'));
      tabContents[i].classList.remove('hidden');
    });
  });
</script>

{% include 'partials/tracking.html' %}
{% endblock %}
