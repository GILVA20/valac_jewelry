{% extends "base.html" %}

{% block title %}VALAC Joyas{% endblock %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<style>
  :root{
    --lux-gold:#D5A300; --lux-gold-600:#B38F00;
    --lux-oxblood:#7A0019; --lux-oxblood-600:#5E0013;
    --lux-text:#1F2937; --lux-muted:#6B7280; --lux-ivory:#FFFBF2;
  }
  /* Evitar scroll horizontal accidental */
  html, body { overflow-x: hidden; }

  /* ---------- GATEWAY GÉNERO ---------- */
  .gender-card{
    position: relative; border-radius: 1rem; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,.12);
    isolation:isolate;
  }
  .gender-card img{
    width:100%; height:100%; object-fit:cover; display:block;
    aspect-ratio: 3/2;
  }
  .gender-overlay{
    position:absolute; inset:0; display:flex; flex-direction:column; justify-content:flex-end;
    padding:1rem 1rem 1.25rem; background:linear-gradient(180deg, rgba(0,0,0,0) 30%, rgba(0,0,0,.55) 100%);
    color:#fff; z-index:1;
  }
  .gender-cta{
    display:inline-block; margin-top:.5rem; padding:.6rem 1rem; font-weight:700; border-radius:.5rem;
    background:#fff; color:#111; border:1px solid #eee; transition:all .2s ease;
  }
  .gender-cta:hover{ background:#111; color:var(--lux-gold); border-color:#000; }

  /* ---------- BADGE OFERTA + CHIPS ---------- */
  .discount-badge{
    position:absolute; top:.5rem; right:.5rem; z-index:10;
    background:var(--lux-oxblood); color:#fff; border:1px solid var(--lux-oxblood-600);
    font-size:.75rem; font-weight:700; text-transform:uppercase;
    padding:.25rem .75rem; border-radius:9999px; box-shadow:0 2px 10px rgba(122,0,25,.18);
  }
  .offer-chip{ font-size:.70rem; padding:.125rem .5rem; border-radius:9999px; display:inline-block; background:var(--lux-ivory); color:var(--lux-text); border:1px solid #E5D6A3; }
  .chip-emi{ font-weight:700; color:var(--lux-gold-600); border-color:var(--lux-gold); }
  .chip-time{ font-weight:700; color:var(--lux-oxblood); border-color:var(--lux-oxblood); }
  .ahorro-text{ color:var(--lux-gold-600); font-weight:600; }

  /* CTA oferta */
  .cta-offer{
    background:linear-gradient(90deg, var(--lux-gold) 0%, #FACC15 100%) !important;
    color:#111 !important; font-weight:800; border:1px solid #E6B800 !important; border-radius:.5rem;
    padding:.5rem 1rem; box-shadow:0 4px 12px rgba(213,163,0,.25); transition:all .25s ease-in-out;
  }
  .cta-offer:hover{ background:#111 !important; color:var(--lux-gold) !important; border-color:var(--lux-gold-600) !important; }

  /* Tarjetas producto */
  #product-grid .group:hover{ box-shadow:0 8px 24px rgba(31,41,55,0.08); }
  #product-grid h3{ color:var(--lux-text); }
  #product-grid .text-gray-600{ color:var(--lux-muted) !important; }
  #product-grid .line-through{ color:#8B9097 !important; }

  /* ---------- CATEGORÍAS QUICK NAV CON FONDO ---------- */
  .gender-toggle button{
    border:1px solid #e5e7eb; padding:.5rem .9rem; border-radius:.5rem; font-weight:600;
  }
  .gender-toggle button.active{
    background:#111; color:var(--lux-gold); border-color:#000;
  }
  .cat-tile{
    position:relative; border-radius:.75rem; overflow:hidden; background:#f7f7f7;
    display:flex; align-items:center; justify-content:center; aspect-ratio: 5/4;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
  }
  .cat-tile span{ font-weight:700; letter-spacing:.2px; }

  /* Fondo con fade */
  #cat-bg{ position:absolute; inset:0; background-size:cover; background-position:center; transition:opacity .35s ease; }
  .opacity-0{ opacity:0 !important; }
</style>

{# Preload de fondos para evitar flicker #}
<link rel="preload" as="image" href="{{ SUPABASE_STORAGE_URL }}gold-earring.jpg">
<link rel="preload" as="image" href="{{ SUPABASE_STORAGE_URL }}cadenasjorge.jpg">
{% endblock %}

{% block content %}
<main class="pt-24 md:pt-28 lg:pt-32">

  {# ---------- GATEWAY POR GÉNERO (sin slider) ---------- #}
  <section class="container mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
      <a href="/collection?genero=Mujer&mix_unisex=1" class="gender-card group" aria-label="Entrar a Colección Mujer">
        <img src="{{ SUPABASE_STORAGE_URL }}jasmin-chew-UBeNYvk6ED0-unsplash.jpg" alt="Colección Mujer">
        <div class="gender-overlay">
          <h2 class="text-2xl sm:text-3xl font-playfair drop-shadow">Colección Mujer</h2>
          <p class="opacity-90">Anillos, cadenas, aretes, dijes y pulsos en oro 10k y 14k.</p>
          <span class="gender-cta">Ver piezas</span>
        </div>
      </a>

      <a href="/collection?genero=Hombre&mix_unisex=1" class="gender-card group" aria-label="Entrar a Colección Hombre">
        <img src="{{ SUPABASE_STORAGE_URL }}mangoldchain.jpg" alt="Colección Hombre">
        <div class="gender-overlay">
          <h2 class="text-2xl sm:text-3xl font-playfair drop-shadow">Colección Hombre</h2>
          <p class="opacity-90">Cadenas, dijes, pulsos y más. Unisex incluido.</p>
          <span class="gender-cta">Ver piezas</span>
        </div>
      </a>
    </div>
  </section>

  {# ---------- BLOQUE COMERCIAL: OFERTAS o NOVEDADES ---------- #}
  <section id="productos-destacados" class="py-10 sm:py-12 bg-white">
    <div class="container mx-auto px-4">
      <h2 class="text-2xl sm:text-3xl font-semibold mb-6 sm:mb-8 text-center text-gray-800">Productos Destacados</h2>
      <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8"></div>
      <div class="mt-8 text-center">
        <a href="/collection?sort=novedades" class="bg-yellow-500 text-white px-5 sm:px-6 py-3 rounded-lg text-lg sm:text-xl hover:bg-yellow-600 transition-colors inline-block">
          Ver Colección Completa
        </a>
      </div>
    </div>
  </section>

  {# ---------- ACCESOS RÁPIDOS POR CATEGORÍA + TOGGLE GÉNERO CON FONDO ---------- #}
  <section
    id="cat-section"
    class="relative my-12 rounded-2xl overflow-hidden ring-1 ring-black/5 shadow-lg"
    data-bg-mujer="{{ SUPABASE_STORAGE_URL }}gold-earring.jpg"
    data-bg-hombre="{{ SUPABASE_STORAGE_URL }}cadenasjorge.jpg"
  >
    <!-- Fondo intercambiable + velo -->
    <div id="cat-bg" style="background-image:url('{{ SUPABASE_STORAGE_URL }}gold-earring.jpg')"></div>
    <div class="absolute inset-0 bg-white/78 md:bg-white/70"></div>

    <div class="relative z-10 container mx-auto px-4 py-6 md:py-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl sm:text-2xl font-semibold">Explora por categoría</h3>
        <div class="gender-toggle space-x-2">
          <button type="button" data-gender="Mujer" class="active">Mujer</button>
          <button type="button" data-gender="Hombre">Hombre</button>
        </div>
      </div>

      <div id="cats-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
        {# Tiles con href dinámico por JS #}
        <a class="cat-tile flex-col" data-cat="aretes"   href="#"><span>Aretes</span></a>
        <a class="cat-tile flex-col" data-cat="cadenas"  href="#"><span>Cadenas</span></a>
        <a class="cat-tile flex-col" data-cat="anillos"  href="#"><span>Anillos</span></a>
        <a class="cat-tile flex-col" data-cat="dijes"    href="#"><span>Dijes</span></a>
        <a class="cat-tile flex-col" data-cat="pulsos"   href="#"><span>Pulsos</span></a>
      </div>

      <p class="text-sm text-gray-500 mt-2">* Unisex aparece en ambos.</p>
    </div>
  </section>

  {# ---------- NUESTRA HISTORIA (ligero) ---------- #}
  <section class="py-10 sm:py-12 bg-white text-gray-800">
    <div class="container mx-auto px-4 flex flex-col md:flex-row items-center gap-6 md:gap-8">
      <div class="md:w-1/2" data-aos="fade-right" data-aos-duration="1000">
        <img src="{{ SUPABASE_STORAGE_URL }}our-story.jpg" alt="Nuestra Historia" class="rounded-lg shadow-lg w-full h-auto object-cover">
      </div>
      <div class="md:w-1/2 md:pl-2" data-aos="fade-left" data-aos-duration="1000">
        <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">Nuestra Historia</h2>
        <p class="text-base sm:text-lg leading-relaxed">
          En VALAC Joyas, la tradición y la pasión por el oro se transmiten de generación en generación.
          Cada pieza es el reflejo de compromiso, calidad y elegancia.
        </p>
      </div>
    </div>
  </section>

  {# ---------- RESEÑAS (estático, ligero) ---------- #}
  <section class="bg-white pb-12">
    <div class="container mx-auto px-4">
      <h2 class="text-2xl sm:text-3xl font-semibold mb-6 sm:mb-8 text-gray-800 text-center">Reseñas de Clientes</h2>
      <div class="grid sm:grid-cols-3 gap-4">
        <div class="bg-white p-5 rounded-lg shadow text-center">
          <p>"Estoy encantada con mi compra en VALAC Joyas. La calidad es insuperable y el servicio excepcional."</p>
          <p class="mt-2 font-semibold">- Joss G.</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow text-center">
          <p>"Piezas hermosas y entrega rápida. Definitivamente volveré a comprar."</p>
          <p class="mt-2 font-semibold">- Daniel O.</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow text-center">
          <p>"La elegancia y el detalle en cada pieza son impresionantes. ¡Lo recomiendo!"</p>
          <p class="mt-2 font-semibold">- Marco M.</p>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block scripts_extra %}
<script type="module">
  // --------- Helpers: construir links de categoría ---------
  const setCategoryLinks = (genero) => {
    document.querySelectorAll('#cats-grid a[data-cat]').forEach(a => {
      const cat = a.getAttribute('data-cat');
      a.href = `/collection?genero=${encodeURIComponent(genero)}&category=${encodeURIComponent(cat)}&mix_unisex=1&sort=novedades`;
    });
  };

  // --------- Fondo por género (fade) + toggle ---------
  const catSection = document.getElementById('cat-section');
  const catBg      = document.getElementById('cat-bg');
  const btns       = document.querySelectorAll('.gender-toggle button');

  function setGeneroCategorias(gen){
    // Links
    setCategoryLinks(gen);
    // Botones activos
    btns.forEach(b => b.classList.toggle('active', b.dataset.gender === gen));
    // Fondo (con pequeño fade)
    const url = gen === 'Mujer' ? catSection.dataset.bgMujer : catSection.dataset.bgHombre;
    catBg.classList.add('opacity-0');
    setTimeout(() => {
      catBg.style.backgroundImage = `url('${url}')`;
      catBg.classList.remove('opacity-0');
    }, 120);
  }

  // Estado inicial
  let currentGender = 'Mujer';
  setGeneroCategorias(currentGender);

  // Eventos
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      currentGender = btn.dataset.gender;
      setGeneroCategorias(currentGender);
    });
  });

  // --------- Carga dinámica de productos: Ofertas -> Novedades ----------
  document.addEventListener("DOMContentLoaded", async function(){
    try{
      const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
      const supabaseClient = createClient("{{ config['SUPABASE_URL'] }}", "{{ config['SUPABASE_KEY'] }}");

      const { data: products, error } = await supabaseClient
        .from('products')
        .select(`
          id, nombre, descripcion, precio, descuento_pct, precio_descuento,
          tipo_producto, genero, tipo_oro, imagen, created_at, stock_total,
          product_images ( imagen, orden )
        `);

      if (error) { console.error(error); return; }

      const hasOffer = (p) => Number(p.descuento_pct) > 0 && Number(p.precio_descuento) > 0 && Number(p.precio_descuento) < Number(p.precio);
      const effectivePrice = (p) => hasOffer(p) ? Number(p.precio_descuento) : Number(p.precio);
      const mxn = (n) => Number(n).toLocaleString('es-MX',{style:'currency',currency:'MXN'});

      const ofertas = products.filter(p => hasOffer(p) && Number(p.stock_total) > 0).sort((a,b)=> effectivePrice(a)-effectivePrice(b));
      const novedades = products.filter(p => !hasOffer(p) && Number(p.stock_total) > 0).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));

      const titulo = document.querySelector('#productos-destacados h2');
      const lista = (ofertas.length ? (titulo.textContent='Ofertas', ofertas) : (titulo.textContent='Novedades', novedades)).slice(0,6);

      const grid = document.getElementById('product-grid');
      grid.innerHTML = '';
      const placeholder = "{{ config['SUPABASE_STORAGE_URL'] }}placeholder.jpg";

      lista.forEach((product, i) => {
        let mainImage = placeholder, hoverImage = null;
        if (product.product_images?.length){
          const sorted = [...product.product_images].sort((a,b)=> a.orden-b.orden);
          mainImage = sorted[0]?.imagen || placeholder;
          hoverImage = sorted[1]?.imagen || null;
        } else if (product.imagen && product.imagen!=='undefined'){ mainImage = product.imagen; }

        const ahorroAbs = hasOffer(product) ? (Number(product.precio)-Number(product.precio_descuento)) : 0;
        const lowStock  = Number(product.stock_total) <= 3 ? `<p class="mt-1 text-sm" style="color: var(--lux-oxblood); font-weight:600;">🔥 ¡Últimas ${product.stock_total} piezas!</p>` : ``;

        grid.innerHTML += `
          <div class="relative bg-white p-5 rounded-lg shadow-md overflow-hidden group" data-aos="fade-up" data-aos-delay="${i*50}">
            ${hasOffer(product)?`<span class="discount-badge">OFERTA ${Number(product.descuento_pct)}%</span>`:''}
            <div class="relative w-full h-64 overflow-hidden">
              <img src="${mainImage}" alt="${product.nombre}" loading="lazy"
                class="w-full h-full object-cover transition-opacity duration-300 ${hoverImage?'group-hover:opacity-0':''}">
              ${hoverImage?`<img src="${hoverImage}" alt="${product.nombre} hover" loading="lazy"
                class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300 group-hover:opacity-100">`:''}
            </div>
            <h3 class="text-xl font-semibold mt-4">${product.nombre}</h3>
            ${hasOffer(product)?`
              <p class="text-gray-500 line-through mt-2">${mxn(product.precio)}</p>
              <div class="flex items-baseline gap-2">
                <p class="text-2xl font-semibold text-amber-800 mt-0.5">${mxn(product.precio_descuento)}</p>
                <span class="offer-chip chip-emi">3 y 6 MSI</span>
              </div>
              <p class="text-sm ahorro-text mt-1">Ahorras ${mxn(ahorroAbs)} (${Number(product.descuento_pct)}%) • <span class="offer-chip chip-time">Oferta limitada</span></p>
            `:`
              <p class="text-2xl font-semibold text-gray-800 mt-2">${mxn(product.precio)}</p>
            `}
            ${lowStock}
            <p class="text-gray-600 mt-1 text-sm">Oro: ${product.tipo_oro} | Género: ${product.genero}</p>
            <a href="/producto/${product.id}" class="mt-4 inline-block px-4 py-2 rounded transition-colors ${hasOffer(product)?'cta-offer':'bg-gray-900 text-white hover:bg-black'}">
              ${hasOffer(product)?'Comprar ahora':'Ver detalles'}
            </a>
          </div>`;
      });

      if (window.AOS) AOS.refresh();
    }catch(err){ console.error(err); }
  });

  // --------- Tracking básico de ruta ---------
  const sessionId = localStorage.getItem("valac_session_id") || crypto.randomUUID();
  localStorage.setItem("valac_session_id", sessionId);
  fetch("/api/track-route",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname,session_id:sessionId})});
</script>

{% include 'partials/tracking.html' %}
{% endblock %}
