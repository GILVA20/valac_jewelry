{% extends "base.html" %}

{% block title %}Pagar con MercadoPago - VALAC Joyas{% endblock %}

{% block content %}
<main class="pt-24 container mx-auto px-4 pb-40">

  <!-- Progreso -->
  <div class="mb-8">
    <ul class="flex justify-between text-sm font-medium" aria-label="Progreso de compra">
      {% set steps = ['Carrito','Datos','Pago','Confirmación'] %}
      {% for s in steps %}
      <li class="flex-1 text-center">
        <div class="{% if loop.index <= 3 %}text-yellow-500 font-semibold{% else %}text-gray-300{% endif %}">{{ s }}</div>
        {% if not loop.last %}
        <div class="mx-auto mt-1 h-1 w-3/4 {% if loop.index < 3 %}bg-yellow-500{% else %}bg-gray-200{% endif %}"></div>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>

  <h1 class="text-3xl font-bold mb-4">Realiza tu pago</h1>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Resumen de Compra (usar valores del backend) -->
    <aside class="lg:col-span-1">
      <div
        class="sticky top-24 bg-white p-6 rounded-lg shadow space-y-6"
        id="order_summary"
        data-subtotal="{{ (subtotal or 0) }}"
        data-discount="{{ (discount or 0) }}"
        data-shipping="{{ (shipping or 0) }}"
        data-total="{{ (total or 0) }}"
        data-coupon="{{ coupon_code or '' }}"
      >
        <h3 class="text-xl font-semibold">Resumen de tu Compra</h3>
        <div class="space-y-2 text-gray-700">
          <div class="flex justify-between">
            <span>Subtotal</span>
            <span id="subtotal">${{ '%.2f' % (subtotal or 0) }}</span>
          </div>

          {% if (discount or 0) > 0 %}
          <div class="flex justify-between text-red-600">
            <span>Descuento{% if coupon_code %} ({{ coupon_code }}){% endif %}</span>
            <span id="discount">- ${{ '%.2f' % (discount or 0) }}</span>
          </div>
          {% endif %}

          <div class="flex justify-between">
            <span>Envío</span>
            <span id="shipping">${{ '%.2f' % (shipping or 0) }}</span>
          </div>

          <div class="border-t pt-2 flex justify-between font-bold">
            <span>Total</span>
            <span id="total">${{ '%.2f' % (total or 0) }}</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Wallet de MercadoPago -->
    <div id="wallet_container" class="lg:col-span-2 flex justify-center"></div>
  </div>

  <div id="mp-error" class="text-red-600 mt-4" style="display:none;"></div>
</main>
{% endblock %}

{% block scripts_extra %}
<script src="https://sdk.mercadopago.com/js/v2" async defer></script>
<script>
  window.onload = function () {
    console.log("Window fully loaded in checkout.");
    AOS.init();

    // 1) SDK cargado
    if (typeof MercadoPago === "undefined") {
      const msg = "Error: El SDK de MercadoPago no se ha cargado correctamente.";
      console.error(msg);
      const el = document.getElementById("mp-error");
      el.style.display = "block"; el.textContent = msg + " Verifica la URL y tu conexión de red.";
      return;
    }

    // 2) Clave pública (usa la variable pasada por el backend)
    const publicKey = "{{ MP_PUBLIC_KEY }}";
    console.log("MP_PUBLIC_KEY:", publicKey);
    if (!publicKey || publicKey.trim() === "") {
      const msg = "Error: La clave pública de MercadoPago no está definida.";
      console.error(msg);
      const el = document.getElementById("mp-error");
      el.style.display = "block"; el.textContent = msg;
      return;
    }

    // 3) preference_id
    const preferenceId = "{{ preference_id }}";
    console.log("Preference ID:", preferenceId);
    if (!preferenceId || preferenceId.trim() === "") {
      const msg = "Error: El preference_id no está definido.";
      console.error(msg);
      const el = document.getElementById("mp-error");
      el.style.display = "block"; el.textContent = msg + " Verifica la generación en el backend.";
      return;
    }

    // Inicializar MP + Wallet
    try {
      const mp = new MercadoPago(publicKey, { locale: "es-MX" });
      mp.bricks().create("wallet", "wallet_container", {
        initialization: { preferenceId },
        customization: { texts: { valueProp: "smart_option" } },
      });
    } catch (err) {
      console.error("Error al renderizar Wallet:", err);
      const el = document.getElementById("mp-error");
      el.style.display = "block"; el.textContent = "Error al renderizar el componente de pago. Detalles: " + err;
      return;
    }

    // ⚠️ IMPORTANTE:
    // Quitamos el recálculo con localStorage (antes ignoraba el descuento).
    // Si quieres refrescar por JS, toma SIEMPRE los valores del backend (data-*):
    const box = document.getElementById("order_summary");
    const fmt = (n) => "$" + Number(n||0).toFixed(2);

    document.getElementById("subtotal").textContent = fmt(box.dataset.subtotal);
    const discount = Number(box.dataset.discount || 0);
    const discountEl = document.getElementById("discount");
    if (discountEl) discountEl.textContent = "- " + fmt(discount);

    document.getElementById("shipping").textContent = fmt(box.dataset.shipping);
    document.getElementById("total").textContent    = fmt(box.dataset.total);
  };
</script>
{% endblock %}
