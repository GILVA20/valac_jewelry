<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Agregar Producto - Supabase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <!-- Incluye FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Agregar Nuevo Producto</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, message in messages %}
                <div class="p-4 mb-2 rounded-lg {% if category == 'error' %}bg-red-200 text-red-800{% elif category == 'success' %}bg-green-200 text-green-800{% else %}bg-gray-200 text-gray-800{% endif %}">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <form method="POST">
            <!-- Nombre -->
            <div class="mb-6">
                <label for="nombre" class="block text-gray-700 font-medium mb-2">Nombre:</label>
                <input type="text" id="nombre" name="nombre" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <!-- Descripción -->
            <div class="mb-6">
                <label for="descripcion" class="block text-gray-700 font-medium mb-2">Descripción:</label>
                <textarea id="descripcion" name="descripcion" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" required></textarea>
            </div>

            <!-- Precio -->
            <div class="mb-6">
                <label for="precio" class="block text-gray-700 font-medium mb-2">Precio:</label>
                <input type="number" step="0.01" id="precio" name="precio" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <!-- Tipo de Producto -->
            <div class="mb-6">
                <label for="tipo_producto" class="block text-gray-700 font-medium mb-2">Tipo de Producto:</label>
                <select id="tipo_producto" name="tipo_producto" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Selecciona un tipo de producto</option>
                    <option value="Anillos">Anillos</option>
                    <option value="Collares">Collares</option>
                    <option value="Pulsos">Pulsos</option>
                    <option value="Cadenas">Cadenas</option>
                    <option value="Dijes">Dijes</option>
                    <option value="Aretes">Aretes</option>
                </select>
            </div>

            <!-- Categoría (Género) -->
            <div class="mb-6">
                <label for="genero" class="block text-gray-700 font-medium mb-2">Categoría:</label>
                <select id="genero" name="genero" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Selecciona el género</option>
                    <option value="Hombre">Hombre</option>
                    <option value="Mujer">Mujer</option>
                    <option value="Unisex">Unisex</option>
                </select>
            </div>

            <!-- Tipo de Oro -->
            <div class="mb-6">
                <label for="tipo_oro" class="block text-gray-700 font-medium mb-2">Tipo de Oro:</label>
                <select id="tipo_oro" name="tipo_oro" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Selecciona el tipo de oro</option>
                    <option value="10k">10k</option>
                    <option value="14k">14k</option>
                </select>
            </div>

            <!-- Subir Imagen 
            <div class="mb-6">
                <label for="file-upload" class="block text-gray-700 font-medium mb-2">Subir Imagen:</label>
                <div class="flex items-center justify-center w-full">
                    <label for="file-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500">
                        <i id="upload-icon" class="fas fa-upload text-gray-500 text-2xl mb-2"></i>
                        <p class="text-gray-500">Haz clic para subir una imagen</p>
                    </label>
                    <input type="file" id="file-upload" accept="image/*" onchange="handleFileUpload(event)" class="hidden">
                </div>
                <p id="upload-status" class="text-sm text-gray-500 mt-2"></p>
            </div>

             Campo oculto para la URL de la imagen 
            <input type="hidden" id="imagen" name="imagen"> -->

            +   <!-- Subir Múltiples Imágenes -->
           <div class="mb-6">
             <label for="file-upload" class="block text-gray-700 font-medium mb-2">Subir Imágenes:</label>
             <input type="file" id="file-upload" accept="image/*" multiple class="block w-full border border-gray-300 p-2 rounded-lg">
             <p id="upload-status" class="text-sm text-gray-500 mt-2">Puedes subir varias imágenes. La primera será la principal.</p>
           </div>
           <input type="hidden" id="imagen" name="imagen">  <!-- Principal -->
           <input type="hidden" id="imagenes_multiples" name="imagenes_multiples">

            <!-- Botón de Enviar -->
            <div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    Agregar Producto
                </button>
            </div>
        </form>
    </div>

    <!-- Bloque de JavaScript: Coloca esto justo antes del cierre de </body> -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // Inyecta las variables de configuración desde Flask
        const SUPABASE_URL = "{{ config['SUPABASE_URL'] }}";
        const SUPABASE_KEY = "{{ config['SUPABASE_KEY'] }}";
        
        // Inicializa el cliente Supabase usando la función importada
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Cliente Supabase inicializado:", supabaseClient);
        const uploadInput = document.getElementById("file-upload");
        const uploadStatus = document.getElementById("upload-status");
        const imagenPrincipal = document.getElementById("imagen");
        const imagenesMultiples = document.getElementById("imagenes_multiples");

        async function subirImagen(file) {
            const fileName = 'products/' + Date.now() + '-' + file.name;
            console.log("Subiendo archivo:", fileName);
            const { data, error } = await supabaseClient
                .storage
                .from('CatalogoJoyasValacJoyas')
                .upload(fileName, file);
            if (error) {
                console.error("Error en la subida:", error);
                throw error;
            }
            const { data: urlData, error: urlError } = supabaseClient
                .storage
                .from('CatalogoJoyasValacJoyas')
                .getPublicUrl(fileName);
            if (urlError) {
                console.error("Error obteniendo URL pública:", urlError);
                throw urlError;
            }
            let publicURL = urlData.publicURL || urlData.publicUrl;
            if (!publicURL || publicURL === "undefined") {
                throw new Error("La URL pública es undefined");
            }
            publicURL += "?t=" + new Date().getTime();
            console.log("URL de descarga:", publicURL);
            return publicURL;
        }

        uploadInput.addEventListener("change", async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            const urls = [];
            uploadStatus.innerText = "Subiendo imágenes...";

            for (let file of files) {
                try {
                    const url = await subirImagen(file);
                    urls.push(url);
                } catch (err) {
                    console.error("Error subiendo imagen:", err);
                    uploadStatus.innerText = "Error subiendo alguna imagen.";
                    uploadStatus.classList.add("text-red-500");
                    return;
                }
            }

            if (urls.length) {
                imagenPrincipal.value = urls[0];
                imagenesMultiples.value = JSON.stringify(urls);
                uploadStatus.innerText = "Imágenes subidas correctamente.";
                uploadStatus.classList.add("text-green-500");
                console.log("Imágenes cargadas:", urls);
            }
        });

    </script>
</body>
</html>
