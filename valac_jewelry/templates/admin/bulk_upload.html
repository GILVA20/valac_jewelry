<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga Masiva de Productos - ValacJoyas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <!-- FontAwesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Estilos adicionales para esta secci√≥n */
    .drag-over { border-color: #007BFF !important; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <!-- Header -->
    <h1 class="text-3xl font-bold mb-6 text-center text-dark">Subida Masiva üöÄ</h1>
    
    <!-- Secci√≥n 1: Drag & Drop CSV -->
    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition hover:border-blue-500">
      <p class="text-gray-500">Arrastra y suelta el archivo CSV aqu√≠ o haz clic para seleccionar</p>
      <input type="file" id="csv-input" accept=".csv" class="hidden">
    </div>
    
    <!-- Secci√≥n 2: Rutas de Im√°genes -->
    <div class="mt-6">
      <label for="image-paths" class="block text-gray-700 font-medium mb-2">Rutas de im√°genes:</label>
      <div class="flex items-center space-x-4">
        <input type="text" id="image-paths" placeholder="Ingresa rutas separadas por coma" class="flex-grow border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="btn-search-images" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded">
          <i class="fas fa-search mr-2"></i> Buscar
        </button>
      </div>
    </div>
    
    <!-- Secci√≥n 3: Vista Previa -->
    <div id="preview" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    
    <!-- Secci√≥n 4: Barra de Progreso -->
    <div id="progress-bar" class="mt-6 w-full bg-gray-300 rounded-full h-4 overflow-hidden">
      <div id="progress-fill" class="bg-blue-500 h-4 rounded-full" style="width: 0%;"></div>
    </div>
    
    <!-- Secci√≥n 5: Resultados -->
    <div id="results" class="mt-6"></div>
    
    <!-- Bot√≥n de Subida -->
    <div class="mt-6 text-center">
      <button id="btn-upload" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition" disabled>
        ¬°Subir lote! (üöÄ)
      </button>
    </div>
  </div>

  <script>
    // Elementos del DOM
    const dropZone = document.getElementById('drop-zone');
    const csvInput = document.getElementById('csv-input');
    const btnUpload = document.getElementById('btn-upload');
    const previewDiv = document.getElementById('preview');
    const progressFill = document.getElementById('progress-fill');
    const resultsDiv = document.getElementById('results');
    let csvFile = null;
    let previewData = [];

    // Drag & Drop handlers
    dropZone.addEventListener('click', () => csvInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        csvInput.files = e.dataTransfer.files;
        handleCSV(e.dataTransfer.files[0]);
      }
    });

    csvInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        handleCSV(e.target.files[0]);
      }
    });

    // Procesa el CSV y genera vista previa
    function handleCSV(file) {
      csvFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const rows = content.split("\n").filter(r => r.trim() !== "");
        if (rows.length < 2) return;
        const headers = rows[0].split(",").map(h => h.trim());
        previewData = rows.slice(1, 51).map(row => {
          const cols = row.split(",");
          let obj = {};
          headers.forEach((header, index) => {
            obj[header] = cols[index] ? cols[index].trim() : "";
          });
          return obj;
        });
        renderPreview();
        btnUpload.disabled = false;
      };
      reader.readAsText(file);
    }

    // Renderiza la previsualizaci√≥n de productos
    function renderPreview() {
      previewDiv.innerHTML = "";
      previewData.forEach(product => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow hover:shadow-lg transition transform hover:scale-105";
        card.innerHTML = `
          <h2 class="text-xl font-bold mb-2">${product.nombre || 'Sin nombre'}</h2>
          <p class="text-gray-700 mb-2">${product.descripcion || 'Sin descripci√≥n'}</p>
          <p class="text-green-600 font-bold">Precio: ${product.precio}</p>
        `;
        previewDiv.appendChild(card);
      });
    }

    // Actualiza la barra de progreso
    function updateProgress(percent) {
      progressFill.style.width = percent + "%";
    }

    // Muestra los resultados de la operaci√≥n
    function showResults(report) {
      resultsDiv.innerHTML = "";
      if (report.success && report.success.length) {
        const successDiv = document.createElement("div");
        successDiv.innerHTML = `<p class="text-green-600 font-bold">‚úÖ √âxito: ${report.success.length} productos</p>`;
        const ul = document.createElement("ul");
        ul.className = "list-disc ml-6";
        report.success.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          ul.appendChild(li);
        });
        successDiv.appendChild(ul);
        resultsDiv.appendChild(successDiv);
      }
      if (report.warnings && report.warnings.length) {
        const warnDiv = document.createElement("div");
        warnDiv.innerHTML = `<p class="text-yellow-600 font-bold">‚ö†Ô∏è Advertencias: ${report.warnings.length}</p>`;
        const ul = document.createElement("ul");
        ul.className = "list-disc ml-6";
        report.warnings.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          ul.appendChild(li);
        });
        warnDiv.appendChild(ul);
        resultsDiv.appendChild(warnDiv);
      }
      if (report.errors && report.errors.length) {
        const errorDiv = document.createElement("div");
        errorDiv.innerHTML = `<p class="text-red-600 font-bold">‚ùå Errores: ${report.errors.length}</p>`;
        const ul = document.createElement("ul");
        ul.className = "list-disc ml-6";
        report.errors.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          ul.appendChild(li);
        });
        errorDiv.appendChild(ul);
        resultsDiv.appendChild(errorDiv);
      }
    }

    // Env√≠a el CSV al endpoint de carga masiva
    btnUpload.addEventListener('click', async () => {
      if (!csvFile) return;
      btnUpload.disabled = true;
      updateProgress(0);
      resultsDiv.innerHTML = "";
      const formData = new FormData();
      formData.append('csv', csvFile);
      formData.append('image_paths', document.getElementById('image-paths').value);
      
      try {
        const response = await fetch('/api/bulk-upload', { method: 'POST', body: formData });
        const report = await response.json();
        updateProgress(100);
        showResults(report);
      } catch (error) {
        console.error("Error al subir el lote:", error);
        resultsDiv.innerHTML = `<p class="text-red-600 font-bold">‚ùå Error en la carga masiva</p>`;
      } finally {
        btnUpload.disabled = false;
      }
    });
  </script>
</body>
</html>
