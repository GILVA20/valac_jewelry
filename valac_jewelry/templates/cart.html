{% extends "base.html" %}

{% block title %}
  Carrito - VALAC Joyas
{% endblock %}

{% block content %}
<main class="pt-24 container mx-auto p-6">
  <div class="flex flex-col md:flex-row gap-8">
    <!-- Columna Izquierda: Lista de productos en el carrito -->
    <section class="w-full md:w-2/3">
      <h1 class="text-3xl font-bold text-[#333333] mb-8 font-playfair">Tus Artículos</h1>
      {% if products %}
        <div class="space-y-6" id="cart-items">
          {% for p in products %}
          <div class="bg-white p-5 rounded-lg shadow-md flex flex-col product-card" data-product-id="{{ p.id }}">
            <img src="{{ p.imagen or url_for('static', filename='images/placeholder.jpg') }}" alt="{{ p.nombre }}" class="w-full h-64 object-cover mb-4 rounded">
            <h3 class="text-xl font-semibold text-[#333333] font-playfair">{{ p.nombre }}</h3>
            <p class="text-gray-800 mt-2 font-bold">$ {{ p.precio }}</p>
            <!-- Control de cantidad: En este caso se limita a 1 unidad por compra -->
            <p class="mt-2 text-gray-600">Cantidad: 1</p>
            <!-- Botón para eliminar producto -->
            <button class="remove-item mt-4 bg-red-600 text-white px-4 py-2 rounded-full hover:bg-red-700 transition-colors" data-product-id="{{ p.id }}">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-600">No hay productos en el carrito.</p>
      {% endif %}
    </section>

    <!-- Columna Derecha: Resumen de Compra y Cupón -->
    <aside class="w-full md:w-1/3 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold font-playfair mb-4">Resumen de Compra</h2>
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Subtotal:</span>
        <span id="subtotal" class="font-bold text-gray-900">$0.00</span>
      </div>
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Envío:</span>
        <span id="shipping" class="font-bold text-gray-900">$50.00</span>
      </div>
      <div class="flex justify-between mb-4 border-t pt-2">
        <span class="text-gray-700">Total:</span>
        <span id="total" class="font-bold text-gray-900">$0.00</span>
      </div>
      <!-- Sección para aplicar cupón -->
      <div class="coupon-section" data-aos="fade-up" data-aos-duration="1000">
        <label for="coupon" class="block text-gray-700 mb-2">Código de Cupón</label>
        <input type="text" id="coupon" class="coupon-input" placeholder="Ingresa tu cupón">
        <button id="apply-coupon-btn" class="apply-coupon-btn mt-2">Aplicar Cupón</button>
        <!-- Mensaje animado para cupón aplicado -->
        <div id="coupon-message" class="hidden text-green-600 font-semibold mt-2" data-aos="fade-in" data-aos-duration="500">
          ¡Cupón aplicado con éxito!
        </div>
      </div>
      <!-- Botón para proceder al pago -->
      <button id="checkout-btn" class="mt-6 w-full bg-gradient-to-r from-[#D4AF37] to-[#C09330] hover:from-[#B38F00] hover:to-[#967700] text-white px-6 py-3 rounded-full font-semibold transition-colors shadow-md">
        Proceder al Pago
      </button>
    </aside>
  </div>
</main>
{% endblock %}

{% block scripts_extra %}
<script>
  // Simulación del carrito: en un entorno real, estos datos vendrían del backend o de localStorage.
  let cartItems = [
    {% for p in products %}
    {
      id: {{ p.id }},
      nombre: "{{ p.nombre }}",
      precio: {{ p.precio }},
      cantidad: {{ p.cantidad or 1 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Función para calcular el subtotal
  const calculateSubtotal = () => {
    return cartItems.reduce((sum, item) => sum + item.precio * item.cantidad, 0);
  };

  // Actualiza el resumen de la compra
  const updateSummary = () => {
    const subtotal = calculateSubtotal();
    const shipping = subtotal > 0 ? 50 : 0;
    const total = subtotal + shipping;
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('shipping').textContent = `$${shipping.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    // Persistencia en localStorage (opcional)
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
  };

  // Evento para eliminar producto del carrito
  document.querySelectorAll('.remove-item').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = parseInt(btn.getAttribute('data-product-id'));
      cartItems = cartItems.filter(item => item.id !== id);
      // Remover el elemento del DOM
      btn.closest('.product-card').remove();
      updateSummary();
    });
  });

  // Inicializar resumen al cargar la página
  updateSummary();

  // Evento para aplicar cupón: "DESCUENTO10" otorga 10% de descuento
  document.getElementById('apply-coupon-btn').addEventListener('click', () => {
    const couponCode = document.getElementById('coupon').value.trim();
    const couponMsg = document.getElementById('coupon-message');
    if (couponCode === "DESCUENTO10") {
      const subtotal = calculateSubtotal();
      const discount = subtotal * 0.10;
      const shipping = subtotal > 0 ? 50 : 0;
      const total = subtotal + shipping - discount;
      document.getElementById('subtotal').textContent = `$${(subtotal - discount).toFixed(2)}`;
      document.getElementById('total').textContent = `$${total.toFixed(2)}`;
      // Agregar animación al botón
      document.getElementById('apply-coupon-btn').classList.add('animate-bounce');
      // Mostrar mensaje de éxito
      couponMsg.textContent = "¡Cupón aplicado con éxito!";
      couponMsg.classList.remove('hidden');
      // Ocultar mensaje y quitar animación después de 3 segundos
      setTimeout(() => {
        couponMsg.classList.add('hidden');
        document.getElementById('apply-coupon-btn').classList.remove('animate-bounce');
      }, 3000);
    } else {
      alert("Código de cupón inválido");
    }
  });

  // Evento para proceder al pago (simulado)
  document.getElementById('checkout-btn').addEventListener('click', () => {
    alert("Redirigiendo a la página de pago...");
    window.location.href = '/checkout';
  });

  // Inicialización de AOS para animaciones
  document.addEventListener("DOMContentLoaded", () => {
    AOS.init();
  });
</script>
{% endblock %}
