<!-- Banner superior tipo marquee (izq -> der) -->
<div id="top-promo" class="fixed top-0 left-0 right-0 z-50 bg-black text-amber-300 shadow-[0_1px_0_rgba(255,255,255,0.08)]">
  <div class="container mx-auto px-3 md:px-4 py-1.5 flex items-center gap-3">
    <div class="marquee flex-1" role="region" aria-label="Promociones">
      {% set msgs = promo_msgs or [
        'Hasta 6 MSI con Mercado Pago',
        'ðŸ”¥ Oro 10k y 14k',
        'ðŸšš EnvÃ­os a todo MÃ©xico'
      ] %}
      {% set joined = msgs|join('  â€¢  ') %}
      <div class="marquee-track ltr">
        <span class="marquee-item">{{ joined }}</span>
        <span class="marquee-item" aria-hidden="true">{{ joined }}</span>
      </div>
    </div>
    <button id="promo-close"
            class="shrink-0 text-white/70 hover:text-white text-xs px-2 py-1 rounded"
            aria-label="Cerrar anuncio">âœ•</button>
  </div>
</div>

<header id="site-header"
         class="fixed left-0 right-0 z-40 bg-white/95 backdrop-blur shadow-md"
         style="top: var(--promo-offset, 0px)">
  <style>
    :root{
      --promo-offset: 0px;     /* altura del banner */
      --header-total: 72px;    /* banner + header (JS lo recalcula) */
    }

    /* deja espacio global para header fijo + banner */
    body.has-fixed-header{ padding-top: var(--header-total); }
    /* evita doble espacio si el primer bloque ya trae pt-/mt- */
    body.has-fixed-header > main:first-of-type,
    body.has-fixed-header > section:first-of-type,
    body.has-fixed-header > .container:first-of-type,
    body.has-fixed-header > #app:first-of-type{
      padding-top:0 !important;
      margin-top:0 !important;
    }
    /* anclas internas que respeten el header */
    html{ scroll-padding-top: var(--header-total); }

    /* --- Marquee --- */
    .marquee{ position:relative; overflow:hidden; }
    .marquee-track{
      display:flex; gap:4rem;
      white-space:nowrap; will-change:transform;
      animation: marquee 24s linear infinite;
    }
    /* izquierda -> derecha */
    .marquee-track.ltr{ animation-direction: reverse; }
    .marquee-item{ flex:0 0 auto; padding-inline:1rem; }
    .marquee:hover .marquee-track{ animation-play-state: paused; }
    @keyframes marquee{
      from{ transform: translateX(0); }
      to  { transform: translateX(-50%); } /* 2 copias => loop perfecto */
    }
    @media (max-width:640px){ .marquee-track{ animation-duration:18s; } }
    @media (prefers-reduced-motion:reduce){
      .marquee-track{ animation:none; transform:translateX(0); }
    }

    /* micro detalles visuales */
    .nav-link{position:relative}
    .nav-link:after{content:"";position:absolute;left:0;bottom:-6px;height:2px;width:0;background:#D4AF37;transition:width .2s ease}
    .nav-link:hover:after,.nav-link[aria-current="page"]:after{width:100%}
    .btn-cart-bling{transition:transform .15s ease}
    .btn-cart-bling:hover{transform:translateY(-1px)}
    .badge-count{min-width:1.25rem;height:1.25rem;font-size:.75rem;line-height:1.25rem}
    @media (prefers-reduced-motion:no-preference){
      .badge-pulse{animation:badgePulse 2.2s ease-in-out infinite}
      @keyframes badgePulse{0%,100%{box-shadow:0 0 0 0 rgba(212,175,55,.45)}50%{box-shadow:0 0 0 .5rem rgba(212,175,55,0)}}
    }
  </style>

  <div class="container mx-auto flex justify-between items-center px-4 md:px-6 py-3 md:py-4">
    <!-- Logo -->
    <a href="/" class="text-2xl sm:text-3xl md:text-4xl font-playfair tracking-wide nav-link hover:text-[#D4AF37]">
      VALAC Joyas
    </a>

    <!-- BotÃ³n hamburguesa (mÃ³vil) -->
    <button id="menu-toggle"
            class="lg:hidden text-3xl focus:outline-none"
            aria-label="Abrir menÃº" aria-expanded="false" aria-controls="mobile-menu">
      <i class="fas fa-bars" aria-hidden="true"></i>
    </button>

    <!-- NAV (desktop) -->
    <nav class="hidden lg:flex items-center gap-5 xl:gap-7 text-lg lg:text-xl text-[#1f2937]">
      <a href="/" class="nav-link hover:text-[#D4AF37]">Inicio</a>

      <!-- ColecciÃ³n + MEGA-MENÃš -->
      <div class="relative group">
        <button id="mega-trigger"
                class="nav-link hover:text-[#D4AF37] flex items-center gap-1"
                aria-haspopup="true" aria-expanded="false">
          ColecciÃ³n
          <svg class="w-4 h-4 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>

        <!-- MEGA-MENÃš -->
        <div id="mega-menu"
             class="absolute left-1/2 -translate-x-1/2 top-full mt-3 w-[680px] max-w-[92vw]
                    bg-white rounded-2xl shadow-xl ring-1 ring-gray-200 p-6
                    opacity-0 invisible translate-y-2 transition duration-200 ease-out
                    group-hover:visible group-hover:opacity-100 group-hover:translate-y-0
                    group-focus-within:visible group-focus-within:opacity-100 group-focus-within:translate-y-0 z-50">
          <div class="grid grid-cols-2 gap-8 text-[#424242]">
            {% for g in ['Hombre','Mujer'] %}
            <div>
              <h4 class="font-bold text-xl flex items-center gap-2">
                {{ g }}
                <span class="h-[2px] w-12 bg-[#D4AF37] inline-block ml-2"></span>
              </h4>
              <ul class="mt-3 space-y-2">
                {% for c in ['aretes','cadenas','anillos','dijes','pulsos'] %}
                <li>
                  <a href="/collection?genero={{ g }}&category={{ c }}&mix_unisex=1"
                     class="flex items-center gap-2 py-1 px-2 rounded-md hover:bg-gray-50 hover:text-[#D4AF37] capitalize">
                    <i class="fas fa-gem text-sm opacity-80"></i>
                    {{ c }}
                  </a>
                </li>
                {% endfor %}
              </ul>
              <a href="/collection?genero={{ g }}&mix_unisex=1"
                 class="mt-4 inline-flex items-center gap-2 text-sm text-[#1f2937] hover:text-[#D4AF37]">
                Ver todo {{ g }} <i class="fas fa-arrow-right text-xs"></i>
              </a>
            </div>
            {% endfor %}
          </div>

          <div class="mt-5 pt-4 border-t border-gray-100 flex items-center justify-between">
            <a href="/collection?category=ofertas" class="inline-flex items-center gap-2 text-[#7A0019] font-semibold">
              <i class="fas fa-bolt"></i> Ofertas activas
            </a>
            <a href="/collection" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md border border-[#D4AF37] text-[#1f2937] hover:bg-[#D4AF37] hover:text-black transition">
              Explorar toda la colecciÃ³n
            </a>
          </div>
        </div>
      </div>

      <a href="/about"   class="nav-link hover:text-[#D4AF37]">Sobre&nbsp;Nosotros</a>
      <a href="/contact" class="nav-link hover:text-[#D4AF37]">Contacto</a>

      <!-- Carrito -->
      <a href="/cart"
         class="btn-cart-bling relative inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[#D4AF37]/60 hover:border-[#D4AF37] transition">
        <i class="fas fa-shopping-cart text-xl" aria-hidden="true"></i>
        <span>Carrito</span>
        <span class="badge-count badge-pulse absolute -top-2 -right-2 rounded-full bg-[#D4AF37] text-black font-semibold text-center px-1">
          {{ cart_count|default(0) }}
        </span>
      </a>
    </nav>

    <!-- Redes -->
    <div class="hidden lg:flex items-center gap-4 text-2xl">
      <a href="https://www.facebook.com/profile.php?id=61575867485928"
         target="_blank" rel="noopener noreferrer"
         class="hover:text-[#D4AF37]" aria-label="Facebook VALAC Joyas" title="Facebook">
        <i class="fab fa-facebook" aria-hidden="true"></i>
      </a>

      <a href="https://www.instagram.com/valacjoyas/"
         target="_blank" rel="noopener noreferrer"
         class="hover:text-[#D4AF37]" aria-label="Instagram VALAC Joyas" title="Instagram">
        <i class="fab fa-instagram" aria-hidden="true"></i>
      </a>
    </div>
  </div>

  <!-- MenÃº mÃ³vil -->
  <div id="mobile-menu" class="hidden lg:hidden bg-white shadow-md border-t border-gray-100">
    <nav class="flex flex-col p-4 space-y-2 text-[17px]">
      <a href="/" class="py-2 px-3 rounded-md hover:bg-gray-100">Inicio</a>

      <!-- AcordeÃ³n ColecciÃ³n -->
      <details class="rounded-md">
        <summary class="py-2 px-3 rounded-md hover:bg-gray-100 cursor-pointer list-none flex justify-between items-center">
          <span class="font-semibold">ColecciÃ³n</span>
          <i class="fas fa-chevron-down text-sm opacity-70"></i>
        </summary>
        <div class="mt-2 space-y-3 pl-3">
          {% for g in ['Hombre','Mujer'] %}
          <div>
            <div class="font-semibold text-[#D4AF37]">{{ g }}</div>
            <div class="flex flex-col ml-2">
              {% for c in ['aretes','cadenas','anillos','dijes','pulsos'] %}
                <a href="/collection?genero={{ g }}&category={{ c }}&mix_unisex=1"
                   class="py-1.5 px-2 rounded-md hover:bg-gray-100 capitalize">
                  {{ c }}
                </a>
              {% endfor %}
              <a href="/collection?genero={{ g }}&mix_unisex=1" class="py-1.5 px-2 rounded-md hover:bg-gray-100">
                Ver todo {{ g }}
              </a>
            </div>
          </div>
          {% endfor %}
          <a href="/collection?category=ofertas" class="py-1.5 px-2 rounded-md hover:bg-gray-100 text-[#7A0019] font-semibold">
            Ofertas activas
          </a>
        </div>
      </details>

      <a href="/about" class="py-2 px-3 rounded-md hover:bg-gray-100">Sobre Nosotros</a>
      <a href="/contact" class="py-2 px-3 rounded-md hover:bg-gray-100">Contacto</a>

      <a href="/cart" class="py-2 px-3 rounded-md hover:bg-gray-100 flex items-center gap-2">
        <i class="fas fa-shopping-cart"></i> Carrito
        <span class="ml-auto inline-flex items-center justify-center badge-count rounded-full bg-[#D4AF37] text-black font-semibold px-1">
          {{ cart_count|default(0) }}
        </span>
      </a>
    </nav>
  </div>

  <script>
    // Debounce helper
    const debounce = (fn,ms=120)=>{ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a),ms); }; };

    // Offsets dinÃ¡micos (banner + header fijo)
    (function(){
      const promo  = document.getElementById('top-promo');
      const header = document.getElementById('site-header');
      const body   = document.body;

      function updateOffsets(){
        const promoH  = (promo && !promo.classList.contains('hidden'))
                        ? Math.ceil(promo.getBoundingClientRect().height) : 0;
        const headH   = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
        document.documentElement.style.setProperty('--promo-offset', promoH + 'px');
        document.documentElement.style.setProperty('--header-total', (promoH + headH) + 'px');
        body.classList.add('has-fixed-header');
      }

      // Eventos base
      document.addEventListener('DOMContentLoaded', updateOffsets);
      window.addEventListener('load', updateOffsets);
      window.addEventListener('resize', debounce(updateOffsets, 100));
      setTimeout(updateOffsets, 0);

      // Recalcular cuando cambie la altura (fuentes, wrap de texto, etc.)
      if (window.ResizeObserver) {
        const ro = new ResizeObserver(debounce(updateOffsets, 50));
        promo && ro.observe(promo);
        header && ro.observe(header);
      }
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(updateOffsets).catch(()=>{});
      }

      // Cerrar banner (persistencia por campaÃ±a)
      const closeBtn = document.getElementById('promo-close');
      const KEY = '{{ promo_key|default("promo-2025-08-27") }}';
      if (localStorage.getItem(KEY)==='1'){ promo?.classList.add('hidden'); updateOffsets(); }
      closeBtn?.addEventListener('click', ()=>{
        promo?.classList.add('hidden');
        localStorage.setItem(KEY,'1');
        updateOffsets();
      });
    })();

    // Mobile toggle
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    menuToggle?.addEventListener('click', () => {
      const isOpen = !mobileMenu.classList.contains('hidden');
      mobileMenu.classList.toggle('hidden');
      menuToggle.setAttribute('aria-expanded', String(!isOpen));
    });

    // Mega menÃº accesible
    const trigger = document.getElementById('mega-trigger');
    const panel   = document.getElementById('mega-menu');
    function openMega(){ panel?.classList.remove('invisible','opacity-0','translate-y-2'); trigger?.setAttribute('aria-expanded','true'); }
    function closeMega(){ panel?.classList.add('invisible','opacity-0','translate-y-2');  trigger?.setAttribute('aria-expanded','false'); }
    trigger?.addEventListener('keydown', (e)=>{
      if (e.key==='Enter' || e.key===' ') { e.preventDefault(); openMega(); panel?.querySelector('a')?.focus(); }
      if (e.key==='Escape') { closeMega(); trigger?.focus(); }
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMega(); });
    document.addEventListener('click', (e)=>{
      if (panel && !panel.contains(e.target) && !trigger.contains(e.target)) closeMega();
    });
    trigger?.addEventListener('mouseenter', openMega);
    trigger?.addEventListener('mouseleave', ()=> setTimeout(()=>{ if(!panel?.matches(':hover')) closeMega(); }, 120));
    panel?.addEventListener('mouseleave', closeMega);
  </script>
</header>
