<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Producto - Supabase</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Editar Producto</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4">
          {% for category, message in messages %}
            <div class="p-4 mb-2 rounded-lg {% if category == 'error' %}bg-red-200 text-red-800{% elif category == 'success' %}bg-green-200 text-green-800{% else %}bg-gray-200 text-gray-800{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST"
          action="{{ url_for('supabase_products.edit_product', id=product.id) }}"
          id="edit-form">
      <!-- Nombre -->
      <div class="mb-6">
        <label for="nombre" class="block text-gray-700 font-medium mb-2">Nombre:</label>
        <input type="text" id="nombre" name="nombre"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               value="{{ product.nombre }}" required>
      </div>

      <!-- Descripción -->
      <div class="mb-6">
        <label for="descripcion" class="block text-gray-700 font-medium mb-2">Descripción:</label>
        <textarea id="descripcion" name="descripcion" rows="4" required
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">{{ product.descripcion }}</textarea>
      </div>

      <!-- Precio -->
      <div class="mb-6">
        <label for="precio" class="block text-gray-700 font-medium mb-2">Precio:</label>
        <input type="number" step="0.01" id="precio" name="precio" required
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               value="{{ product.precio }}">
      </div>

      <!-- Descuento (%) -->
      <div class="mb-6">
        <label for="descuento_pct" class="block text-gray-700 font-medium mb-2">Descuento (%):</label>
        <input type="number" id="descuento_pct" name="descuento_pct" min="0" max="100" step="1"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               value="{{ product.descuento_pct or 0 }}">
        <p class="text-xs text-gray-500 mt-1">El precio con descuento se calculará automáticamente en backend.</p>
      </div>

      <!-- Tipo de Producto -->
      <div class="mb-6">
        <label for="tipo_producto" class="block text-gray-700 font-medium mb-2">Tipo de Producto:</label>
        <select id="tipo_producto" name="tipo_producto" required
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="Anillos"  {% if product.tipo_producto == "Anillos"  %}selected{% endif %}>Anillos</option>
          <option value="Dijes"    {% if product.tipo_producto == "Dijes"    %}selected{% endif %}>Dijes</option>
          <option value="Collares" {% if product.tipo_producto == "Collares" %}selected{% endif %}>Collares</option>
          <option value="Pulsos"   {% if product.tipo_producto == "Pulsos"   %}selected{% endif %}>Pulsos</option>
          <option value="Cadenas"  {% if product.tipo_producto == "Cadenas"  %}selected{% endif %}>Cadenas</option>
          <option value="Aretes"   {% if product.tipo_producto == "Aretes"   %}selected{% endif %}>Aretes</option>
        </select>
      </div>

      <!-- Categoría (Género) -->
      <div class="mb-6">
        <label for="genero" class="block text-gray-700 font-medium mb-2">Categoría:</label>
        <select id="genero" name="genero" required
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="Hombre" {% if product.genero == "Hombre" %}selected{% endif %}>Hombre</option>
          <option value="Mujer"  {% if product.genero == "Mujer"  %}selected{% endif %}>Mujer</option>
          <option value="Unisex" {% if product.genero == "Unisex" %}selected{% endif %}>Unisex</option>
        </select>
      </div>

      <!-- Tipo de Oro -->
      <div class="mb-6">
        <label for="tipo_oro" class="block text-gray-700 font-medium mb-2">Tipo de Oro:</label>
        <select id="tipo_oro" name="tipo_oro" required
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="10k" {% if product.tipo_oro == "10k" %}selected{% endif %}>10k</option>
          <option value="14k" {% if product.tipo_oro == "14k" %}selected{% endif %}>14k</option>
        </select>
      </div>

      <!-- Campo oculto portada y buffer de nuevas imágenes -->
      <input type="hidden" id="imagen" name="imagen" value="{{ product.imagen }}">
      <input type="hidden" id="imagenes_multiples" name="imagenes_multiples">

      <!-- Galería + Dropzone (único uploader) -->
      <h3 class="text-lg font-semibold mb-2">Galería Actual</h3>

      <div id="pg-dropzone"
           class="mb-4 border-2 border-dashed rounded-lg p-4 text-center text-gray-500 hover:border-blue-400 transition cursor-pointer">
        Arrastra imágenes aquí o haz clic para seleccionar
        <input
          type="file"
          id="file-upload-multi"
          accept="image/jpeg,image/png,image/webp"
          multiple
          class="hidden">
      </div>

      <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        {% for img in gallery %}
          {% set is_main = (product.imagen and product.imagen == img.imagen) %}
          <div class="border rounded-lg p-2 bg-gray-50 relative shadow-sm {% if is_main %}ring-2 ring-blue-500{% endif %}">
            <img src="{{ img.imagen }}" alt="Imagen {{ loop.index }}"
                 class="w-full h-32 object-cover rounded mb-2 select-none">
            <div class="flex items-center gap-2">
              <input type="number" class="w-full border rounded px-2 py-1 text-center"
                     data-img-id="{{ img.id }}" value="{{ img.orden }}">
              <button type="button" title="Eliminar"
                      class="delete-img bg-red-600 hover:bg-red-700 text-white px-2 rounded"
                      data-id="{{ img.id }}">X</button>
            </div>

            <!-- Botón (sin form anidado) -->
            <button type="button"
                    class="make-primary w-full text-sm border rounded py-1 mt-2
                           {% if is_main %}bg-blue-50 border-blue-500 text-blue-700{% else %}bg-white hover:bg-gray-100{% endif %}"
                    data-image-id="{{ img.id }}">
              {% if is_main %}★ Principal{% else %}☆ Hacer principal{% endif %}
            </button>
          </div>
        {% else %}
          <!-- Si no hay imágenes: placeholder gris para UX -->
          <div class="border rounded-lg p-2 bg-gray-50 relative shadow-sm col-span-2 md:col-span-4">
            <div class="w-full h-32 bg-gray-100 rounded flex items-center justify-center text-gray-400">
              Sin imágenes aún — súbelas con la dropzone de arriba
            </div>
          </div>
        {% endfor %}
      </div>

      <p id="upload-status-multi" class="text-sm text-gray-500 mt-2">
        Puedes subir varias imágenes arrastrándolas. La primera del producto será la portada.
      </p>

      <!-- El botón manual queda oculto; mantenido por compatibilidad -->
      <button type="button" id="save-order"
              class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded mb-6 hidden">
        Guardar Orden
      </button>

      <div>
        <button type="submit"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
          Guardar Cambios
        </button>
      </div>
    </form>
  </div>

  <!-- Toasts -->
  <div id="pg-toasts" aria-live="polite" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <script type="module">
    // SortableJS on-demand
    const Sortable = await import('https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/modular/sortable.esm.js')
      .then(m => m.default);

    // --- Helpers UI ---
    function showToast(msg, type="info") {
      const box = document.getElementById("pg-toasts");
      if (!box) return;
      const el = document.createElement("div");
      el.className = `px-4 py-2 rounded shadow text-white ${
        type==="success" ? "bg-green-600" : type==="error" ? "bg-red-600" : "bg-gray-800"
      }`;
      el.textContent = msg;
      box.appendChild(el);
      setTimeout(()=> el.remove(), 2500);
    }

    // Validación básica
    function isValidImage(file, maxMB = 5) {
      const okType = /image\/(jpeg|png|webp)/.test(file.type);
      const okSize = file.size <= maxMB * 1024 * 1024;
      return okType && okSize;
    }

    // Subida usando el BACKEND (evita CORS)
    async function subirImagen(file, onProgress) {
      if (!isValidImage(file)) throw new Error("JPG/PNG/WEBP hasta 5MB");
      onProgress?.(10);
      const fd = new FormData();
      fd.append("file", file);
      const resp = await fetch("{{ url_for('supabase_products.storage_upload') }}", {
        method: "POST",
        body: fd
      });
      const data = await resp.json().catch(()=> ({}));
      if (!resp.ok || !data.url) {
        throw new Error(data.error || "Falló la subida");
      }
      onProgress?.(100);
      return data.url; // ya viene con ?t=timestamp desde el backend
    }

    // Crear tarjeta “en progreso”
    function createProgressCard() {
      const el = document.createElement("div");
      el.className = "border rounded-lg p-2 bg-gray-50 relative shadow-sm overflow-hidden";
      el.innerHTML = `
        <div class="h-32 bg-gray-100 rounded mb-2 animate-pulse"></div>
        <div class="w-full h-1 bg-gray-200 rounded overflow-hidden">
          <div class="h-full w-0 bg-blue-500" id="bar"></div>
        </div>`;
      return el;
    }

    // Añadir tarjeta final (temporal, sin id hasta guardar)
    function appendTempCard(url) {
      const card = document.createElement("div");
      card.className = "border rounded-lg p-2 bg-gray-50 relative shadow-sm";
      card.innerHTML = `
        <img src="${url}" class="w-full h-32 object-cover rounded mb-2 select-none">
        <div class="flex items-center gap-2">
          <input type="number" class="w-full border rounded px-2 py-1 text-center" value="0" data-img-id="temp-${Date.now()}">
          <button type="button" class="bg-gray-300 text-gray-700 px-2 rounded cursor-not-allowed" title="Se eliminará tras guardar" disabled>—</button>
        </div>
        <div class="mt-2 flex gap-2">
          <button type="button" class="set-temp-primary w-full text-sm border rounded py-1 bg-white hover:bg-gray-100" data-url="${url}">
            ☆ Usar como portada
          </button>
        </div>
        <div class="mt-2 text-xs text-gray-500">Se agregará al guardar</div>
      `;
      document.getElementById("gallery-grid").appendChild(card);
    }

    // Dropzone
    const dropzone = document.getElementById("pg-dropzone");
    const multiInput = document.getElementById("file-upload-multi");
    const uploadStatus = document.getElementById("upload-status-multi");
    const imagenesMultiples = document.getElementById("imagenes_multiples");

    dropzone.addEventListener("click", () => multiInput.click());
    dropzone.addEventListener("dragover", (e)=>{ e.preventDefault(); dropzone.classList.add("border-blue-500"); });
    dropzone.addEventListener("dragleave", ()=> dropzone.classList.remove("border-blue-500"));
    dropzone.addEventListener("drop", (e)=>{
      e.preventDefault();
      dropzone.classList.remove("border-blue-500");
      if (e.dataTransfer?.files?.length) queueFiles(e.dataTransfer.files);
    });

    multiInput.addEventListener("change", (e)=>{
      if (e.target.files?.length) queueFiles(e.target.files);
      e.target.value = ""; // reset
    });

    function queueFiles(fileList) {
      const files = Array.from(fileList);
      if (!files.length) return;

      uploadStatus.textContent = "Subiendo imágenes...";
      (async ()=>{
        const newUrls = [];
        for (const file of files) {
          const shell = createProgressCard();
          document.getElementById("gallery-grid").appendChild(shell);
          const bar = shell.querySelector("#bar");

          try {
            const url = await subirImagen(file, p => { bar.style.width = p + "%"; });
            shell.remove();
            appendTempCard(url);
            newUrls.push(url);
          } catch (err) {
            shell.innerHTML = `<div class="text-red-600 text-sm">Error subiendo: ${file.name}</div>`;
          }
        }

        if (newUrls.length) {
          const prev = (()=>{ try { return JSON.parse(imagenesMultiples.value||"[]"); } catch(_){ return []; }})();
          imagenesMultiples.value = JSON.stringify(prev.concat(newUrls));

          // ⚑ Portada automática: usar la primera imagen nueva subida
          const portadaInput = document.getElementById("imagen");
          portadaInput.value = newUrls[0];

          uploadStatus.textContent = "Imágenes listas para guardar.";
          uploadStatus.classList.add("text-green-500");
          showToast("Imágenes añadidas a la galería (pendientes de guardar)", "success");
        } else {
          uploadStatus.textContent = "No se añadieron imágenes.";
        }
      })();
    }

    // Drag & Drop de orden (autosave para imágenes existentes con id)
    const grid = document.getElementById("gallery-grid");
    if (grid) {
      new Sortable(grid, {
        animation: 150,
        ghostClass: "opacity-60",
        onEnd: () => saveOrderNow()
      });
    }

    async function saveOrderNow() {
      const cards = Array.from(document.querySelectorAll("#gallery-grid > div"));
      const orderData = [];
      cards.forEach((card, idx) => {
        const input = card.querySelector('input[type="number"]');
        const id = input?.dataset?.imgId;
        input.value = idx;
        // aceptar cualquier id real (uuid, numérico, etc.) y omitir los "temp-*"
        if (id && !String(id).startsWith("temp-")) {
          orderData.push({ id, orden: idx });
        }
      });
      if (!orderData.length) return;
      await fetch("{{ url_for('supabase_products.update_gallery_order') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order: orderData })
      });
      showToast("Orden guardado", "success");
    }

    // Eliminar imagen existente
    document.querySelectorAll(".delete-img").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!confirm("¿Seguro que deseas eliminar esta imagen?")) return;
        const id = btn.dataset.id;
        fetch(`{{ url_for('supabase_products.delete_gallery_image', image_id='__ID__') }}`.replace('__ID__', id), {
          method: "POST",
          body: new URLSearchParams({ product_id: "{{ product.id }}" })
        }).then(() => location.reload());
      });
    });

    // Hacer principal (botón sin form anidado)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".make-primary");
      if (!btn) return;
      const imgId = btn.dataset.imageId;
      fetch(`{{ url_for('supabase_products.set_primary', image_id='__ID__') }}`.replace('__ID__', imgId), {
        method: "POST"
      }).then(() => location.reload())
        .catch(() => showToast("No se pudo marcar como principal", "error"));
    });

    // Marcar portada entre temporales (sin recargar)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".set-temp-primary");
      if (!btn) return;
      document.getElementById("imagen").value = btn.dataset.url;
      showToast("Portada actualizada (se guardará al confirmar)", "success");
    });

    // ===== Envío con feedback (AJAX) =====
    const form = document.getElementById("edit-form");
    const submitBtn = form?.querySelector('button[type="submit"]');

    function normalizeHiddenArrayField(el) {
      try {
        const raw = (el.value || "").trim();
        if (!raw) { el.value = "[]"; return; }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) el.value = "[]";
      } catch { el.value = "[]"; }
    }

    async function postWithFeedback(e) {
      e.preventDefault();
      normalizeHiddenArrayField(imagenesMultiples);

      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Guardando...";
      showToast("Enviando cambios…", "info");
      console.log("[edit-form] Enviando POST a:", form.action);

      try {
        const fd = new FormData(form);
        const resp = await fetch(form.action, {
          method: "POST",
          body: fd,
          headers: { "X-Requested-With": "fetch" }
        });

        if (resp.redirected) {
          showToast("Guardado. Redirigiendo…", "success");
          console.log("[edit-form] Redirigiendo a", resp.url);
          window.location.href = resp.url;
          return;
        }

        const text = await resp.text();
        if (resp.ok) {
          showToast("Producto actualizado ✅", "success");
          console.log("[edit-form] OK 200. Respuesta:", text.slice(0, 400));
        } else {
          showToast("Error al guardar ❌", "error");
          console.error("[edit-form] Error", resp.status, text);
        }
      } catch (err) {
        showToast("No se pudo enviar la petición", "error");
        console.error("[edit-form] Excepción en fetch:", err);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    if (form && submitBtn) form.addEventListener("submit", postWithFeedback);
  </script>
</body>
</html>
