{% extends "base.html" %}

{% block title %}
  Checkout - VALAC Joyas
{% endblock %}

{% block content %}
<main class="container mx-auto px-4 pb-40 md:pb-0 page-checkout">

    <!-- Título simple -->
    <div class="mb-6 text-center">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Finalizar Compra</h1>
      <p class="text-gray-500 mt-2">Completa tus datos y paga con MercadoPago</p>
    </div>

  {# === NUEVO: variables de base/cupón para usar en ambos resúmenes === #}
  {% set _base = coupon_percent_base if coupon_percent_base is defined else 'products' %}
  {% set _coupon = coupon_code if coupon_code is defined else None %}

  <!-- Resumen del Pedido y mensaje para revisar antes de pagar -->
  <section class="mb-8 p-4 bg-gray-100 rounded-md">
    <h2 class="text-lg font-bold mb-2">Revise su pedido antes de pagar</h2>
          <div id="order-details">
            <div class="flex justify-between mb-1">
              <span>Subtotal:</span>
              <span>${{ '%.2f'|format(subtotal) }}</span>
            </div>
            <div class="flex justify-between mb-1">
              <span>Envío:</span>
              <span>${{ '%.2f'|format(shipping) }}</span>
            </div>
            {% if discount and discount > 0 %}
            <div class="flex justify-between mb-1 text-red-600">
              <span>
                Descuento{% if _coupon %} ({{ _coupon }}){% endif %}
                {% if _base == 'products_plus_shipping' %}
                  <small class="text-gray-600">(aplicado sobre productos + envío)</small>
                {% else %}
                  <small class="text-gray-600">(aplicado sólo sobre productos)</small>
                {% endif %}
              </span>
              <span>-${{ '%.2f'|format(discount) }}</span>
            </div>
            {% endif %}
            <div class="flex justify-between font-bold border-t pt-1">
              <span>Total:</span>
              <span>${{ '%.2f'|format(total) }}</span>
            </div>
          </div>   
  </section>

    <form id="checkout-form" method="POST" action="{{ url_for('checkout.checkout') }}"
          class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Estilos generales y específicos para el formulario -->
    <style>
      body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
        color: #333;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
        font-size: 1rem;
        min-height: 44px;
        transition: box-shadow 0.3s, border-color 0.3s;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group input:hover,
      .form-group select:hover {
        border-color: #d5a300;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .input-icon { position: relative; }
      .input-icon i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #d5a300;
      }
      .input-icon input { padding-left: 2.5rem; }
      .validation-message {
        font-size: 0.9rem;
        color: #e3342f;
        margin-top: 0.25rem;
        display: none;
      }
      
      /* ===== Layout fixes: evitar overlap con header fijo + banner ===== */
      /* El header/base define --header-total vía JS con la altura real (banner + header). */
      .page-checkout{
        /* si por alguna razón aún no está definida, cae a 88px */
        padding-top: var(--header-total, 88px);
      }

      /* Resumen sticky solo en desktop y respetando el header/banner */
      @media (min-width:1024px){
        .sticky-summary{
          position: sticky;
          top: calc(var(--header-total, 88px) + 1rem);
        }
      }
      @media (max-width:1023px){
        .sticky-summary{ position: static; top: auto; }
      }

      /* Contenedor para el botón de MercadoPago: respeta header/banner */
      #mp-button-container {
        display: block;
        margin: 1rem 0;
      }
      #wallet_container {
        min-height: 100px;
      }

      .validation-message.valid { color: #38c172; display: block; }
      .validation-message.error { display: block; }
      .form-section {
        border-top: 2px solid #eee;
        padding-top: 1.5rem;
        margin-bottom: 1.5rem;
      }
      /* Botón Finalizar: se muestra si no se usa el brick de MercadoPago */
      #finalize-btn {
        transition: background-color 0.5s, transform 0.3s, box-shadow 0.3s;
        font-size: 1.2rem;
        font-weight: 700;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        width: 100%;
        background-color: #d5a300;  /* color primario (amarillo) */
        color: #333;
      }
      #finalize-btn.loading {
        background-color: #967700;
        cursor: not-allowed;
        transform: scale(0.98);
      }
      #finalize-btn:hover { 
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        transform: scale(1.02);
      }
      .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #fff;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-left: 0.5rem;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      /* Banner de Confirmación para MercadoPago */
      #mp-confirm-banner {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #e6f4ea;
        border: 1px solid #38c172;
        color: #38c172;
        font-size: 1rem;
        display: none;
      }
      /* Mensaje para Aplazo no disponible */
      #aplazo-message {
        color: #e3342f;
        font-size: 1rem;
        margin-top: 1rem;
        display: none;
      }

      /* Ajuste temporal: Forzar un valor mínimo para evitar superposición */
      .page-checkout {
        padding-top: calc(var(--header-total, 120px)); /* Incremento del valor mínimo */
      }
    </style>

    <!-- Datos de Envío y Facturación -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section class="form-section" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="mb-4 text-xl font-bold">Datos de Envío y Facturación</h2>
        <!-- Campo Nombre -->
        <div class="form-group">
          <label for="nombre"><i class="fas fa-user mr-2"></i>Nombre Completo</label>
          <div class="input-icon">
            <i class="fas fa-user"></i>
            <input type="text" id="nombre" name="nombre" placeholder="Tu nombre" required
                   autocomplete="name">
          </div>
          <span id="nombre-msg" class="validation-message"></span>
        </div>
        <!-- Campo Dirección -->
        <div class="form-group">
          <label for="direccion"><i class="fas fa-map-marker-alt mr-2"></i>Dirección Completa</label>
          <div class="input-icon">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="direccion" name="direccion" placeholder="Calle, número, colonia, ciudad" required
                   autocomplete="street-address">
          </div>
          <span id="direccion-msg" class="validation-message"></span>
        </div>
        <!-- Campo Estado (oculto, valor por defecto) -->
        <input type="hidden" id="estado" name="estado" value="México">
        <!-- Campo Colonia (oculto) -->
        <input type="hidden" id="colonia" name="colonia" value="-">
        <!-- Campo Ciudad (oculto) -->
        <input type="hidden" id="ciudad" name="ciudad" value="-">
        <!-- Campo Código Postal -->
        <div class="form-group">
          <label for="codigo_postal"><i class="fas fa-mail-bulk mr-2"></i>Código Postal</label>
          <input type="text" id="codigo_postal" name="codigo_postal" placeholder="Código Postal" required
                 inputmode="numeric" autocomplete="postal-code" pattern="[0-9]{5}">
          <span id="codigo_msg" class="validation-message"></span>
        </div>
        <!-- Campo Teléfono -->
        <div class="form-group">
          <label for="telefono"><i class="fas fa-phone mr-2"></i>Teléfono</label>
          <input type="tel" id="telefono" name="telefono" placeholder="Ej. +521234567890" required
                 inputmode="tel" autocomplete="tel">
          <span id="telefono-msg" class="validation-message"></span>
        </div>
        <!-- Campo Correo -->
        <div class="form-group">
          <label for="email"><i class="fas fa-envelope mr-2"></i>Correo Electrónico</label>
          <input type="email" id="email" name="email" placeholder="tu@correo.com" required
                 inputmode="email" autocomplete="email">
          <small class="text-gray-500 text-xs mt-1 block">
            <i class="fas fa-envelope-open-text mr-1"></i>Te enviaremos la confirmación y tracking aquí
          </small>
          <span id="email-msg" class="validation-message"></span>
        </div>
      </section>

      <!-- Información de Pago - MercadoPago automático -->
      <section class="form-section" data-aos="fade-up" data-aos-duration="1200">
        <h2 class="mb-4 text-xl font-bold"><i class="fas fa-credit-card mr-2 text-blue-600"></i>Pago Seguro</h2>
        
        <!-- MercadoPago seleccionado por defecto (oculto) -->
        <input type="hidden" id="metodo_pago" name="metodo_pago" value="mercadopago">
        
        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center gap-3 mb-3">
            <img src="https://cdn.simpleicons.org/mercadopago" alt="MercadoPago" class="h-8">
            <span class="font-semibold text-gray-800">Pago con MercadoPago</span>
          </div>
          <div class="flex flex-wrap gap-3 text-gray-600 text-sm">
            <span><i class="fas fa-credit-card mr-1"></i>Tarjetas</span>
            <span><i class="fas fa-store mr-1"></i>OXXO</span>
            <span><i class="fas fa-university mr-1"></i>SPEI</span>
            <span><i class="fas fa-calendar-alt mr-1"></i>Hasta 12 MSI</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">
            <i class="fas fa-shield-alt mr-1 text-green-600"></i>
            No guardamos datos de tu tarjeta. Pago 100% seguro.
          </p>
        </div>
      </section>
    </div>

    <!-- Elementos de Confianza: Aquí se incluye un sello de seguridad y se podría agregar un testimonio o mini-carrito -->
    <section class="trust-section text-center mt-8">
      <p class="text-sm text-gray-600">Compra 100% segura con SSL</p>
      <p class="mt-2 italic text-sm text-gray-700">“+10,000 compras seguras”</p>
    </section>
    

    <!-- Botón de Finalizar Compra (si no se usa el brick de MercadoPago) -->

        <!-- Sticky Sidebar / Footer -->
        <aside class="lg:col-span-1">
          <!-- CAMBIO AQUÍ: usar sticky-summary para que respete --header-total -->
          <div class="sticky-summary bg-white p-6 rounded-lg shadow space-y-6">
            <h3 class="text-xl font-semibold">Resumen de tu Compra</h3>
                         <div class="space-y-2 text-gray-700">
                            <div class="flex justify-between">
                              <span>Subtotal</span>
                              <span>${{ '%.2f'|format(subtotal) }}</span>
                            </div>
                            {% if discount > 0 %}
                            <div class="flex justify-between text-red-600">
                              <span>
                                Descuento{% if _coupon %} ({{ _coupon }}){% endif %}
                                {% if _base == 'products_plus_shipping' %}
                                  <small class="text-gray-600">(aplicado sobre productos + envío)</small>
                                {% else %}
                                  <small class="text-gray-600">(aplicado sólo sobre productos)</small>
                                {% endif %}
                              </span>
                              <span>–${{ '%.2f'|format(discount) }}</span>
                            </div>
                            {% endif %}
                            <div class="flex justify-between">
                              <span>Envío</span>
                              <span>${{ '%.2f'|format(shipping) }}</span>
                            </div>
                            <div class="border-t pt-2 flex justify-between font-bold">
                              <span>Total</span>
                              <span>${{ '%.2f'|format(total) }}</span>
                            </div>
                          </div>
            
            <!-- Botón de MercadoPago (visible desde el inicio) -->
            <div id="mp-button-container" class="w-full">
              <div id="wallet_container"></div>
            </div>
            
            <div class="mt-3 text-center space-y-2">
              <p class="text-xs text-gray-500">Pago 100% seguro</p>
              <div
                class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2
                       grayscale opacity-80 hover:opacity-100 transition"
                aria-label="Métodos de pago disponibles"
              >
                <img src="https://cdn.simpleicons.org/visa"            alt="Visa"             title="Visa"            class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
                <img src="https://cdn.simpleicons.org/mastercard"      alt="Mastercard"       title="Mastercard"      class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
                <img src="https://cdn.simpleicons.org/americanexpress" alt="American Express" title="American Express" class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
                <span class="hidden md:inline-block w-px h-6 bg-gray-300"></span>
                <img src="https://cdn.simpleicons.org/mercadopago"     alt="Mercado Pago"     title="Mercado Pago"    class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
                <img src="https://cdn.simpleicons.org/oxxo"            alt="OXXO Pay"         title="OXXO Pay"        class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
                <img src="https://cdn.simpleicons.org/spei"            alt="SPEI"             title="Transferencia SPEI" class="h-5 md:h-6 w-auto align-middle" loading="lazy" />
              </div>
              <p class="text-[11px] text-gray-500">
                Aceptamos tarjetas • OXXO • SPEI — *Hasta 6 MSI con Mercado Pago
              </p>
              <p class="text-sm italic text-gray-600">
                “+10,000 compras seguras”
              </p>
            </div>
          </div>
        </aside>
  </form>
</main>
<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
{% endblock %}

{% block scripts_extra %}
<script>
  /**
   * HEADER/BANNER OFFSET HELPER
   * Calcula y actualiza --header-total (banner + header) para evitar overlap.
   * Busca elementos comunes o con data-attributes:
   *   - Header: [data-site-header], header.site-header, #site-header, header
   *   - Banner: [data-top-banner], #top-banner, #promo-bar, .promo-bar
   */
  (function setupHeaderOffset(){
    const root   = document.documentElement;
    const header = document.querySelector('[data-site-header], header.site-header, #site-header, header');
    const banner = document.querySelector('[data-top-banner], #top-banner, #promo-bar, .promo-bar');

    function computeAndSet() {
      const headerH = header ? header.offsetHeight : 0;
      const bannerH = banner ? banner.offsetHeight : 0;
      const total   = headerH + bannerH;
      root.style.setProperty('--header-total', total + 'px');
    }

    // Recalcular en eventos de ventana
    ['load','resize','orientationchange'].forEach(ev => {
      window.addEventListener(ev, computeAndSet, { passive: true });
    });

    // Observar cambios del DOM en header/banner (por ejemplo, si se abre/cierra un banner)
    [header, banner].filter(Boolean).forEach(el => {
      const mo = new MutationObserver(computeAndSet);
      mo.observe(el, { attributes: true, childList: true, subtree: true });
    });

    // Primer cálculo
    computeAndSet();
  })();
</script>

<script>
  (function debugHeaderOffset() {
    const header = document.querySelector('[data-site-header], header.site-header, #site-header, header');
    const banner = document.querySelector('[data-top-banner], #top-banner, #promo-bar, .promo-bar');

    if (!header) {
      console.warn("Header element not found. Ensure the header has the correct selector.");
    }
    if (!banner) {
      console.warn("Banner element not found. Ensure the banner has the correct selector.");
    }

    const headerHeight = header ? header.offsetHeight : 0;
    const bannerHeight = banner ? banner.offsetHeight : 0;
    const totalHeight = headerHeight + bannerHeight;

    console.log("Header height:", headerHeight);
    console.log("Banner height:", bannerHeight);
    console.log("Total height (header + banner):", totalHeight);

    document.documentElement.style.setProperty('--header-total', `${totalHeight}px`);
  })();
</script>

<script>
  // Función para cargar el SDK de MercadoPago asíncronamente
  function loadMercadoPagoSDK() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://sdk.mercadopago.com/js/v2';
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Error al cargar el SDK de MercadoPago'));
      document.head.appendChild(script);
    });
  }
  // Toast helper
  function toast(msg,type='info'){
    const t=document.createElement('div');
    const colors = {
      'error': 'bg-red-500',
      'success': 'bg-green-500',
      'info': 'bg-blue-500'
    };
    t.className=`px-6 py-3 rounded-lg shadow-lg ${colors[type] || 'bg-blue-500'} text-white font-semibold`;
    t.textContent=msg;
    const container = document.getElementById('toast-container');
    container.appendChild(t);
    setTimeout(()=>{
      t.style.opacity = '0';
      t.style.transition = 'opacity 0.3s';
      setTimeout(() => t.remove(), 300);
    }, 3500);
  }

  window.onload = async function() {
    console.log("Window fully loaded in checkout.");
    AOS.init();
    console.log("AOS initialized globally.");

    try {
      await loadMercadoPagoSDK();
      console.log("SDK de MercadoPago cargado correctamente.");
    } catch (error) {
      console.error("Error al cargar el SDK de MercadoPago:", error);
      alert("Error al cargar el SDK de MercadoPago. Por favor, recarga la página.");
      return;
    }

    // Funciones de validación
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    function validatePhone(phone) {
      const re = /^\+?\d{8,}$/;
      return re.test(phone);
    }
    function validateNotEmpty(value) { return value.trim() !== ""; }
    function validateCardNumber(number) {
      const cleaned = number.replace(/[\s-]/g, '');
      const re = /^\d{16}$/;
      return re.test(cleaned);
    }
    function validateCardExpiration(expiration) {
      const re = /^(0[1-9]|1[0-2])\/\d{2}$/;
      return re.test(expiration);
    }
    function validateCardCVC(cvc) {
      const re = /^\d{3,4}$/;
      return re.test(cvc);
    }


    // --- INTEGRACIÓN DEL AUTORELLENADO SIMULADO ---
    (function() {
      var simularPago = "{{ config['SIMULAR_PAGO'] }}" === "true";

      function formularioVacio() {
        var campos = ['nombre', 'direccion', 'estado', 'colonia', 'ciudad', 'codigo_postal', 'telefono', 'email'];
        return campos.every(function(id) {
          var campo = document.getElementById(id);
          return campo && campo.value.trim() === "";
        });
      }

      function randomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function generarCodigoPostal(estado) {
        var rangos = {
          "CDMX": { min: 1000, max: 16999 },
          "Jalisco": { min: 44100, max: 44999 },
          "Nuevo León": { min: 64000, max: 64999 }
        };
        if (rangos[estado]) {
          return String(randomInt(rangos[estado].min, rangos[estado].max)).padStart(5, '0');
        } else {
          return String(randomInt(10000, 99999));
        }
      }

      function generarTelefono() {
        var digitos = String(randomInt(1,9));
        for (var i = 0; i < 9; i++) {
          digitos += String(randomInt(0,9));
        }
        return "+52" + digitos;
      }

      function generarEmail(nombre) {
        var sinAcentos = nombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        var partes = sinAcentos.toLowerCase().split(" ");
        var base = partes.join(".");
        var dominios = ["gmail.com", "hotmail.com", "outlook.com"];
        return base + "@" + randomElement(dominios);
      }

      function rellenarDatosSimulados() {
        var estados = {
          "CDMX": ["Cuauhtémoc", "Benito Juárez", "Miguel Hidalgo"],
          "Jalisco": ["Guadalajara", "Zapopan", "Tlaquepaque"],
          "Nuevo León": ["Monterrey", "San Nicolás", "Guadalupe"]
        };

        var nombres = ["Juan", "María", "Carlos", "Ana", "Luis", "Sofía", "José"];
        var apellidos = ["García", "Rodríguez", "Hernández", "López", "Martínez", "González"];
        var nombreCompleto = randomElement(nombres) + " " + randomElement(apellidos) + " " + randomElement(apellidos);

        var estadosKeys = Object.keys(estados);
        var estadoSeleccionado = randomElement(estadosKeys);
        var coloniaSeleccionada = randomElement(estados[estadoSeleccionado]);

        var numeroCalle = randomInt(1, 200);
        var direccionGenerada = "Calle " + numeroCalle + " Colonia " + coloniaSeleccionada;

        var codigoPostalGenerado = generarCodigoPostal(estadoSeleccionado);
        var telefonoGenerado = generarTelefono();
        var emailGenerado = generarEmail(nombreCompleto);

        document.getElementById('nombre').value = nombreCompleto;
        document.getElementById('direccion').value = direccionGenerada;
        document.getElementById('estado').value = estadoSeleccionado;
        document.getElementById('colonia').value = coloniaSeleccionada;
        var ciudadesPorEstado = {
          "CDMX": "Ciudad de México",
          "Jalisco": "Guadalajara",
          "Nuevo León": "Monterrey"
        };
        document.getElementById('ciudad').value = ciudadesPorEstado[estadoSeleccionado] || "Ciudad";
        document.getElementById('codigo_postal').value = codigoPostalGenerado;
        document.getElementById('telefono').value = telefonoGenerado;
        document.getElementById('email').value = emailGenerado;

        var campos = ['nombre', 'direccion', 'estado', 'colonia', 'ciudad', 'codigo_postal', 'telefono', 'email'];
        campos.forEach(function(id) {
          var evt = new Event('input', { bubbles: true });
          document.getElementById(id).dispatchEvent(evt);
        });

        console.log("Datos simulados generados:", {
          nombre: nombreCompleto,
          direccion: direccionGenerada,
          estado: estadoSeleccionado,
          colonia: coloniaSeleccionada,
          ciudad: document.getElementById('ciudad').value,
          codigo_postal: codigoPostalGenerado,
          telefono: telefonoGenerado,
          email: emailGenerado
        });
      }

      function activarRellenoSimulado() {
        var metodoPago = document.getElementById('metodo_pago').value;
        if (metodoPago === "mock_gateway" && formularioVacio()) {
          console.log("Ejecutando relleno de datos simulados para 'Pago Simulado'.");
          rellenarDatosSimulados();
        }
      }
      document.getElementById('metodo_pago').addEventListener('change', activarRellenoSimulado);
      setTimeout(activarRellenoSimulado, 500);
    })();
    // --- FIN AUTORELLENADO SIMULADO ---

    // Validación en tiempo real de Email
    document.getElementById('email').addEventListener('input', (e) => {
      const msg = document.getElementById('email-msg');
      if (validateEmail(e.target.value.trim())) {
        msg.textContent = "Correo válido";
        msg.classList.remove('error');
        msg.classList.add('valid');
      } else {
        msg.textContent = "Correo inválido";
        msg.classList.remove('valid');
        msg.classList.add('error');
      }
      msg.style.display = 'block';
    });
    // Validación en tiempo real de Teléfono
    document.getElementById('telefono').addEventListener('input', (e) => {
      const msg = document.getElementById('telefono-msg');
      if (validatePhone(e.target.value.trim())) {
        msg.textContent = "Número válido";
        msg.classList.remove('error');
        msg.classList.add('valid');
      } else {
        msg.textContent = "Número inválido";
        msg.classList.remove('valid');
        msg.classList.add('error');
      }
      msg.style.display = 'block';
    });
    // Validación en tiempo real de Estado
    document.getElementById('estado').addEventListener('input', (e) => {
      const msg = document.getElementById('estado-msg');
      if (validateNotEmpty(e.target.value)) {
        msg.textContent = "Estado ingresado";
        msg.classList.remove('error');
        msg.classList.add('valid');
      } else {
        msg.textContent = "El estado es obligatorio";
        msg.classList.remove('valid');
        msg.classList.add('error');
      }
      msg.style.display = 'block';
    });
    // Validación en tiempo real de Colonia
    document.getElementById('colonia').addEventListener('input', (e) => {
      const msg = document.getElementById('colonia-msg');
      if (validateNotEmpty(e.target.value)) {
        msg.textContent = "Colonia ingresada";
        msg.classList.remove('error');
        msg.classList.add('valid');
      } else {
        msg.textContent = "La colonia es obligatoria";
        msg.classList.remove('valid');
        msg.classList.add('error');
      }
      msg.style.display = 'block';
    });

    // Animación de carga al enviar el formulario - AHORA SE USA PARA ENVIAR DATOS ANTES DEL PAGO
    const formElement = document.getElementById('checkout-form');
    if (formElement) {
      formElement.addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevenir submit tradicional
      });
    }

    // Inicializar botón de MercadoPago si hay preference_id
    const preferenceId = "{{ preference_id if preference_id else '' }}";
    const mpPublicKey = "{{ mp_public_key if mp_public_key else '' }}";
    
    console.log('=== DEBUG MERCADOPAGO ===');
    console.log('Preference ID:', preferenceId);
    console.log('Public Key:', mpPublicKey);
    console.log('Preference ID length:', preferenceId.length);
    console.log('Public Key length:', mpPublicKey.length);
    
    if (preferenceId && mpPublicKey) {
      console.log('✅ Iniciando MercadoPago con preference_id válido');
      try {
        const mp = new MercadoPago(mpPublicKey, { locale: "es-MX" });
        
        const bricksBuilder = mp.bricks();
        
        // Renderizar el botón de MercadoPago
        await bricksBuilder.create('wallet', 'wallet_container', {
          initialization: {
            preferenceId: preferenceId,
            redirectMode: 'self'  // Mantener en la misma pestaña
          },
          customization: {
            texts: {
              valueProp: 'smart_option',
            },
          },
          callbacks: {
            onReady: () => {
              console.log('Botón de MercadoPago listo');
            },
            onSubmit: async () => {
              // Capturar y enviar datos del formulario antes de proceder al pago
              const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                direccion: document.getElementById('direccion').value.trim(),
                estado: document.getElementById('estado').value,
                colonia: document.getElementById('colonia').value,
                ciudad: document.getElementById('ciudad').value,
                codigo_postal: document.getElementById('codigo_postal').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                email: document.getElementById('email').value.trim()
              };

              // Validar campos básicos
              if (!formData.nombre || !formData.direccion || !formData.email) {
                toast('Por favor completa al menos Nombre, Dirección y Email antes de pagar', 'error');
                return false; // Cancelar el pago
              }

              // Guardar datos en sessionStorage para recuperarlos después del pago
              sessionStorage.setItem('checkout_data', JSON.stringify(formData));
              
              // Enviar datos al servidor
              try {
                await fetch('/api/create-preference', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(formData)
                });
              } catch (error) {
                console.error('Error guardando datos:', error);
              }
              
              return true; // Permitir continuar con el pago
            },
            onError: (error) => {
              console.error('Error en MercadoPago:', error);
              toast('Error al procesar el pago', 'error');
            }
          }
        });
        
        console.log('Botón de MercadoPago inicializado correctamente');
      } catch (error) {
        console.error('Error inicializando MercadoPago:', error);
        toast('Error al cargar el botón de pago', 'error');
      }
    } else {
      console.error('❌ No se pudo inicializar MercadoPago');
      console.error('Preference ID válido?:', !!preferenceId);
      console.error('Public Key válido?:', !!mpPublicKey);
      
      // Mostrar un mensaje al usuario
      const walletContainer = document.getElementById('wallet_container');
      if (walletContainer) {
        walletContainer.innerHTML = `
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
            <p class="text-yellow-800 font-semibold mb-2">⚠️ Error al cargar el botón de pago</p>
            <p class="text-yellow-700 text-sm">Por favor recarga la página o contacta a soporte</p>
          </div>
        `;
      }
    }

    // ✨ ADDITIONS ✨: Debug: Environment mode and MP public key (test/prod)
    console.log("DEBUG: Environment mode (backend flag 'sandbox'): ", "{{ sandbox if sandbox is defined else 'prod' }}");
    console.log("DEBUG: MP_PUBLIC_KEY used: ", "{{ config['MP_PUBLIC_KEY_TEST'] if config.get('FLASK_ENV') != 'production' else config['MP_PUBLIC_KEY'] }}");
  };

</script>
<script>
  (function robustHeaderOffset() {
    const root = document.documentElement;
    const header = document.querySelector('[data-site-header], header.site-header, #site-header, header');
    const banner = document.querySelector('[data-top-banner], #top-banner, #promo-bar, .promo-bar']);

    function computeAndSetOffset() {
      const headerHeight = header ? header.offsetHeight : 0;
      const bannerHeight = banner ? banner.offsetHeight : 0;
      const totalHeight = headerHeight + bannerHeight;

      if (totalHeight > 0) {
        root.style.setProperty('--header-total', `${totalHeight}px`);
      } else {
        console.warn("Header or banner height is zero. Check element visibility or selectors.");
      }

      console.log("Computed header total height:", totalHeight);
    }

    // Recalculate on window events
    ['load', 'resize', 'orientationchange'].forEach(event => {
      window.addEventListener(event, computeAndSetOffset, { passive: true });
    });

    // Observe DOM changes in header/banner
    [header, banner].filter(Boolean).forEach(element => {
      const observer = new MutationObserver(computeAndSetOffset);
      observer.observe(element, { attributes: true, childList: true, subtree: true });
    });

    // Initial calculation
    computeAndSetOffset();
  })();
</script>

<script>
  (function debugHeaderAndBannerPresence() {
    const header = document.querySelector('[data-site-header], header.site-header, #site-header, header');
    const banner = document.querySelector('[data-top-banner], #top-banner, #promo-bar, .promo-bar');

    if (!header) {
      console.error("Header element not found. Ensure the header has the correct selector.");
    } else {
      console.log("Header detected with height:", header.offsetHeight);
    }

    if (!banner) {
      console.error("Banner element not found. Ensure the banner has the correct selector.");
    } else {
      console.log("Banner detected with height:", banner.offsetHeight);
    }
  })();
</script>

<script>
  (function adjustHeaderAndPromoOffsets() {
    const promo = document.getElementById('top-promo');
    const header = document.getElementById('site-header');
    const root = document.documentElement;

    function updateOffsets() {
      const promoHeight = promo && !promo.classList.contains('hidden')
        ? Math.ceil(promo.getBoundingClientRect().height)
        : 0;
      const headerHeight = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
      const totalHeight = promoHeight + headerHeight;

      root.style.setProperty('--header-total', `${totalHeight}px`);

      console.log("Promo height:", promoHeight);
      console.log("Header height:", headerHeight);
      console.log("Total header + promo height:", totalHeight);
    }

    // Recalculate offsets on load, resize, and DOM changes
    document.addEventListener('DOMContentLoaded', updateOffsets);
    window.addEventListener('load', updateOffsets);
    window.addEventListener('resize', updateOffsets);

    if (window.ResizeObserver) {
      const observer = new ResizeObserver(updateOffsets);
      promo && observer.observe(promo);
      header && observer.observe(header);
    }
  })();
</script>

{% include 'partials/tracking.html' %}
{% endblock %}
